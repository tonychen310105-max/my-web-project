<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åä½ä¼š Â· æ™ºæ…§é…’åº— IoT æ§åˆ¶å° Demoï¼ˆå‡†äº¤ä»˜çº§ï¼‰</title>
  <style>
    :root{
      --bg0:#0b1220;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --link: rgba(170,220,255,.92);
      --focus: 0 0 0 3px rgba(170,220,255,.18);
      --good: rgba(0,255,180,.95);
      --warn: rgba(255,210,120,.95);
      --bad: rgba(255,120,140,.95);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Microsoft YaHei","Noto Sans CJK SC", sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 20%, rgba(120,170,255,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(255,120,210,.16), transparent 60%),
        radial-gradient(900px 700px at 55% 85%, rgba(0,255,180,.10), transparent 55%),
        linear-gradient(180deg, #070b14 0%, #0b1220 55%, #070b14 100%);
      overflow:hidden;
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap: 14px;
      padding: 14px;
    }
    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; overflow:auto; }
      .sidebar{ position: sticky; top:0; z-index:10; }
    }

    .glass{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    /* Sidebar */
    .sidebar{
      padding:14px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      padding: 10px 10px 14px 10px;
    }
    .logo{
      width:34px; height:34px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(18px 18px at 70% 60%, rgba(170,220,255,.25), transparent 55%),
        rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .brand h1{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .brand p{ margin:2px 0 0 0; font-size: 12px; color: var(--muted2); line-height:1.35; }

    .search{
      display:flex; gap:10px;
      padding: 0 10px 12px 10px;
    }
    .input{
      flex:1;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }
    .input:focus{ box-shadow: var(--focus); border-color: rgba(170,220,255,.28); }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{ background: rgba(255,255,255,.10); }
    .pill:active{ transform: translateY(1px); }

    .nav{
      display:flex; flex-direction:column; gap:6px;
      padding: 8px 6px 10px 6px;
      overflow:auto; min-height:0;
    }
    .navBtn{
      display:flex; align-items:center; justify-content:space-between;
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      text-align:left;
    }
    .navBtn:hover{ background: rgba(255,255,255,.07); }
    .navBtn.active{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.14);
    }
    .navLeft{ display:flex; align-items:center; gap:10px; }
    .icon{
      width:22px; height:22px; border-radius: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.88);
    }
    .navTitle{ font-size: 13px; }
    .badge{
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.84);
      white-space: nowrap;
    }

    .sidebarFooter{
      margin-top:auto;
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .tiny{ font-size:12px; color: var(--muted2); }

    .switch{
      display:flex; gap:6px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }

    /* Main */
    .main{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 14px;
    }
    .topbar h2{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .topbar .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
      max-width: 860px;
    }
    .actions{
      display:flex; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(170,220,255,.14);
      border-color: rgba(170,220,255,.22);
    }

    .content{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      min-height:0;
      overflow:hidden;
    }
    @media (max-width: 1100px){
      .content{ grid-template-columns: 1fr; }
    }

    .panel{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
      overflow:hidden;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 1100px){
      .cards{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 540px){
      .cards{ grid-template-columns: 1fr; }
    }

    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      min-height: 84px;
    }
    .kpi .label{ font-size: 12px; color: var(--muted2); }
    .kpi .value{ font-size: 20px; margin-top: 6px; letter-spacing:.2px; }
    .kpi .hint{ font-size: 12px; color: var(--muted2); margin-top: 6px; line-height:1.35; }
    .dot{
      display:inline-block; width:8px; height:8px; border-radius: 99px;
      margin-right: 8px; transform: translateY(1px);
      background: rgba(255,255,255,.35);
    }

    .tableWrap{
      overflow:auto;
      min-height:0;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 760px;
    }
    th,td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      text-align:left;
      vertical-align: middle;
    }
    th{
      position: sticky; top:0;
      background: rgba(10,16,30,.78);
      backdrop-filter: blur(12px);
      z-index: 5;
      font-size: 12px;
      color: rgba(255,255,255,.76);
      letter-spacing:.2px;
    }
    tr:hover td{ background: rgba(255,255,255,.05); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: rgba(255,255,255,.84); }
    .muted{ color: var(--muted2); }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 4px 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }
    .tag .s{ width:8px; height:8px; border-radius: 99px; background: rgba(255,255,255,.25); }
    .tag.good .s{ background: var(--good); }
    .tag.warn .s{ background: var(--warn); }
    .tag.bad  .s{ background: var(--bad); }

    .rightPanel{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
      overflow:hidden;
    }
    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 8px 8px 0 8px;
    }
    .sectionTitle h3{ margin:0; font-size: 13px; letter-spacing:.2px; color: rgba(255,255,255,.88); }
    .sectionTitle .meta{ font-size: 12px; color: var(--muted2); }

    .detail{
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 180px;
    }
    .detail h4{ margin:0 0 8px 0; font-size: 14px; }
    .detail p{ margin: 6px 0; color: rgba(255,255,255,.78); font-size: 12px; line-height:1.5; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 8px; }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.08); }

    .form{
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
    }
    label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,.76);
      margin-bottom: 6px;
    }
    .field{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      outline:none;
      width: 100%;
    }
    .field:focus{ box-shadow: var(--focus); border-color: rgba(170,220,255,.28); }

    /* Improve dropdown readability across browsers */
    select.field{ color: rgba(255,255,255,.92); }
    select.field option{
      color: #0a101e;
      background: #ffffff;
    }
    /* Dark mode option fallback (some browsers ignore option styles; still helps in many) */
    body:not(.lightMode) select.field option{
      color: rgba(255,255,255,.92);
      background: #0b1220;
    }
    
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 540px){ .grid2{ grid-template-columns: 1fr; } table{ min-width: 720px; } }

    .sliderRow{ display:flex; align-items:center; gap:10px; }
    input[type="range"]{ width:100%; }
    .num{
      min-width: 110px;
      text-align:right;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .note{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      line-height: 1.45;
      margin-top: 10px;
    }

    .toast{
      position: fixed;
      bottom: 14px;
      right: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,16,30,.72);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      color: rgba(255,255,255,.90);
      font-size: 12px;
      opacity: 0;
      transform: translateY(10px);
      transition: .22s ease;
      pointer-events: none;
      max-width: min(560px, calc(100vw - 28px));
    }
    .toast.show{ opacity: 1; transform: translateY(0); }

    /* Light mode */
    .lightMode{
      --card: rgba(255,255,255,.55);
      --stroke: rgba(255,255,255,.45);
      --text: rgba(10,16,30,.92);
      --muted: rgba(10,16,30,.68);
      --muted2: rgba(10,16,30,.55);
      --shadow: 0 20px 60px rgba(0,0,0,.18);
      --link: rgba(0,80,190,.85);
    }
    .lightMode{
      background:
        radial-gradient(1200px 700px at 15% 20%, rgba(120,170,255,.30), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(255,120,210,.20), transparent 60%),
        radial-gradient(900px 700px at 55% 85%, rgba(0,255,180,.16), transparent 55%),
        linear-gradient(180deg, #f2f6ff 0%, #e9f0ff 55%, #f4f7ff 100%);
      color: rgba(10,16,30,.92);
    }
  
    /* Light mode dropdown text */
    body.lightMode select.field{ color: rgba(10,16,30,.92); }
    body.lightMode select.field option{ color: rgba(10,16,30,.92); background:#ffffff; }
</style>
</head>

<body>
  <div class="app">
    <aside class="sidebar glass" id="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>åä½ä¼š Â· æ™ºæ…§é…’åº— IoT</h1>
          <p>å‡†äº¤ä»˜çº§ Demo Â· é—¨é” / ç©ºè°ƒ / ç¯å…‰ / æ´—è¡£ Â· å‘Šè­¦ / å·¥å• / ROI</p>
        </div>
      </div>

      <div class="search">
        <input id="globalSearch" class="input" placeholder="æœç´¢ï¼šé…’åº—/æˆ¿å·/è®¾å¤‡ID/å·¥å•/å‘Šè­¦â€¦" />
        <div class="pill" id="btnRefresh" title="åˆ·æ–°æ¨¡æ‹Ÿæ•°æ®">åˆ·æ–°</div>
      </div>

      <nav class="nav" id="nav">
        <button class="navBtn active" data-view="fleet">
          <span class="navLeft"><span class="icon">ğŸŒ</span><span class="navTitle">èµ„äº§æ€»è§ˆ</span></span>
          <span class="badge" id="badgeHotels">â€”</span>
        </button>
        <button class="navBtn" data-view="devices">
          <span class="navLeft"><span class="icon">ğŸ¨</span><span class="navTitle">è®¾å¤‡ä¸­å¿ƒ</span></span>
          <span class="badge" id="badgeDevices">â€”</span>
        </button>
        <button class="navBtn" data-view="scenes">
          <span class="navLeft"><span class="icon">ğŸ¬</span><span class="navTitle">åœºæ™¯è”åŠ¨</span></span>
          <span class="badge">å¯äº¤äº’</span>
        </button>
        <button class="navBtn" data-view="alerts">
          <span class="navLeft"><span class="icon">ğŸ””</span><span class="navTitle">å‘Šè­¦ä¸­å¿ƒ</span></span>
          <span class="badge" id="badgeAlerts">â€”</span>
        </button>
        <button class="navBtn" data-view="workorders">
          <span class="navLeft"><span class="icon">ğŸ§°</span><span class="navTitle">å·¥å•</span></span>
          <span class="badge" id="badgeWO">â€”</span>
        </button>
        
        <button class="navBtn" data-view="premium">
          <span class="navLeft"><span class="icon">âœ¨</span><span class="navTitle">é«˜ç«¯èƒ½åŠ›</span></span>
          <span class="badge" id="badgePremium">éœ€å®¡æ‰¹</span>
        </button>

        
        <button class="navBtn" data-view="member">
          <span class="navLeft"><span class="icon">ğŸ‘¤</span><span class="navTitle">åä½ä¼šä¼šå‘˜</span></span>
          <span class="badge" id="badgeMember">å¢é•¿</span>
        </button>

        <button class="navBtn" data-view="roi">
          <span class="navLeft"><span class="icon">ğŸ“ˆ</span><span class="navTitle">åŠ ç›Ÿ ROI</span></span>
          <span class="badge">å¯äº¤äº’</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div>
          <div class="tiny">ç¯å¢ƒï¼šæ¼”ç¤ºæ²™ç®±</div>
          <div class="tiny">è§’è‰²ï¼šIoT äº§å“ç»ç† Â· è¿è¥è§†è§’</div>
        </div>
        <div class="switch" id="toggleTheme" title="åˆ‡æ¢ä¸»é¢˜">
          <span>ä¸»é¢˜</span><span class="badge" id="themeBadge">æš—</span>
        </div>
      </div>
    </aside>

    <main class="main glass" id="main">
      <header class="topbar">
        <div>
          <h2 id="viewTitle">èµ„äº§æ€»è§ˆ</h2>
          <div class="sub" id="viewSubtitle">
            ç»Ÿä¸€çœ‹æ¿èšåˆå„é…’åº— IoT è¦†ç›–ç‡ã€åœ¨çº¿ç‡ä¸å…³é”®å‘Šè­¦ã€‚ç‚¹å‡»è¡¨æ ¼è¡Œå¯åœ¨å³ä¾§æŸ¥çœ‹é…’åº—/æˆ¿é—´çº§æ˜ç»†å¹¶è§¦å‘â€œæ´¾å•/è”åŠ¨â€åŠ¨ä½œã€‚
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btnExport">å¯¼å‡ºè§†å›¾</button>
          <button class="btn primary" id="btnQuickAction">ä¸€é”®å¤„ç½®</button>
        </div>
      </header>

      <section class="content">
        <div class="panel" id="leftPanel">
          <div class="cards" id="kpiCards"></div>
          <div class="tableWrap" id="tableWrap">
            <table id="table">
              <thead id="thead"></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="rightPanel" id="rightPanel">
          <div class="sectionTitle">
            <h3>è¯¦æƒ…é¢æ¿</h3>
            <div class="meta" id="detailMeta">æœªé€‰æ‹©</div>
          </div>

          <div class="detail" id="detail">
            <h4>è¯·é€‰æ‹©ä¸€æ¡è®°å½•</h4>
            <p>å·¦ä¾§ç‚¹å‡»é…’åº— / è®¾å¤‡ / å‘Šè­¦ / å·¥å•ï¼Œå°†åœ¨è¿™é‡Œæ˜¾ç¤ºå»ºè®®ã€SOP ä¸å¿«æ·åŠ¨ä½œã€‚</p>
            <div class="row">
              <span class="chip">ä¸€é”®æ´¾å•</span>
              <span class="chip">è§¦å‘åœºæ™¯</span>
              <span class="chip">æŸ¥çœ‹å†å²</span>
            </div>
          </div>

          <!-- common filters -->
          <div class="form" id="contextForm">
            <div class="grid2">
              <div>
                <label>è¿‡æ»¤ï¼šå“ç‰Œ</label>
                <select id="filterBrand" class="field">
                  <option value="ALL">å…¨éƒ¨</option>
                  <option value="å…¨å­£">å…¨å­£</option>
                  <option value="æ¡”å­">æ¡”å­</option>
                  <option value="èŠ±é—´å ‚">èŠ±é—´å ‚</option>
                  <option value="å–œæ‚¦">å–œæ‚¦</option>
                  <option value="æ±‰åº­">æ±‰åº­</option>
                  <option value="ä½ å¥½">ä½ å¥½</option>
                </select>
              </div>
              <div>
                <label>é«˜ç«¯èƒ½åŠ›å¼€é€š</label>
                <select id="filterPremium" class="field">
                  <option value="ALL">å…¨éƒ¨</option>
                  <option value="ON">å·²å¼€é€š</option>
                  <option value="OFF">æœªå¼€é€š</option>
                </select>
              </div>
            </div>
            <div class="grid2" style="margin-top:10px;">
              <div class="grid2">
              <div>
                <label>è¿‡æ»¤ï¼šé…’åº—</label>
                <select id="filterHotel" class="field">
                  <option value="ALL">å…¨éƒ¨</option>
                </select>
              </div>
              <div>
                <label>è¿‡æ»¤ï¼šè®¾å¤‡å“ç±»</label>
                <select id="filterCategory" class="field">
                  <option value="ALL">å…¨éƒ¨</option>
                  <option value="LOCK">æ™ºèƒ½é—¨é”</option>
                  <option value="HVAC">ç©ºè°ƒ</option>
                  <option value="LIGHT">ç¯å…‰</option>
                  <option value="LAUNDRY">æ´—è¡£æœº</option>
                  <option value="GATEWAY">ç½‘å…³</option>
                </select>
              </div>
            </div>
            <div class="note" id="contextNote">
              æç¤ºï¼šåœ¨çœŸå®ç³»ç»Ÿä¸­ï¼Œè¿™é‡Œé€šå¸¸è¿˜ä¼šå åŠ â€œå“ç‰Œ/é—¨åº—ç±»å‹/åŠ ç›Ÿå•†/åŒºåŸŸ/å›ºä»¶ç‰ˆæœ¬/ä¾›åº”å•†â€ç­‰è¿è¥ç»´åº¦ï¼Œç”¨äºè§„æ¨¡åŒ–æ²»ç†ã€‚
            </div>
          </div>

          <!-- scenes -->
          <div class="form" id="sceneForm" style="display:none;">
            <div class="grid2">
              <div>
                <label>åœºæ™¯æ¨¡æ¿</label>
                <select id="sceneTemplate" class="field">
                  <option value="checkin">å…¥ä½æ¬¢è¿ï¼ˆé—¨é”+ç¯å…‰+ç©ºè°ƒï¼‰</option>
                  <option value="checkout">é€€æˆ¿èŠ‚èƒ½ï¼ˆç¯å…‰+ç©ºè°ƒï¼‰</option>
                  <option value="dnd">å…æ‰“æ‰°ï¼ˆé—¨é“ƒ/èµ°å»Šç¯ï¼‰</option>
                  <option value="night">å¤œé—´å…³æ€€ï¼ˆç¯å…‰ä½äº®+ç©ºè°ƒé™éŸ³ï¼‰</option>
                  <option value="laundry">è‡ªåŠ©æ´—è¡£ï¼ˆæ’é˜Ÿ+å‘Šè­¦ï¼‰</option>
                </select>
              </div>
              <div>
                <label>ç›®æ ‡æˆ¿é—´</label>
                <select id="sceneRoom" class="field"></select>
              </div>
            </div>
            <div class="grid2" style="margin-top:10px;">
              <div>
                <label>ç©ºè°ƒè®¾å®šï¼ˆÂ°Cï¼‰</label>
                <div class="sliderRow">
                  <input id="sceneTemp" type="range" min="16" max="30" value="24" />
                  <div class="num" id="sceneTempVal">24</div>
                </div>
              </div>
              <div>
                <label>ç¯å…‰äº®åº¦ï¼ˆ%ï¼‰</label>
                <div class="sliderRow">
                  <input id="sceneLight" type="range" min="0" max="100" value="65" />
                  <div class="num" id="sceneLightVal">65</div>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <span class="chip" id="scenePreview">é¢„è§ˆè”åŠ¨æ•ˆæœ</span>
              <span class="chip" id="sceneExecute">æ‰§è¡Œåœºæ™¯</span>
              <span class="chip" id="sceneExport">å¯¼å‡ºé…ç½®</span>
            </div>
            <div class="note">åœºæ™¯ä»·å€¼ï¼šæŠŠâ€œè®¾å¤‡èƒ½åŠ›â€å°è£…æˆâ€œå¯å”®å–çš„ä½“éªŒâ€ã€‚å¯¹åŠ ç›Ÿå•†è€Œè¨€ï¼Œè¿™å°±æ˜¯å¯é‡åŒ–ã€å¯å¤åˆ¶çš„è¿è¥ SOPã€‚</div>
          </div>

          <!-- roi -->
          <div class="form" id="roiForm" style="display:none;">
            <div class="grid2">
              <div>
                <label>é…’åº—è§„æ¨¡ï¼ˆæˆ¿é—´æ•°ï¼‰</label>
                <div class="sliderRow">
                  <input id="roiRooms" type="range" min="30" max="400" value="160" />
                  <div class="num" id="roiRoomsVal">160</div>
                </div>
              </div>
              <div>
                <label>è®¾å¤‡è¦†ç›–ï¼ˆæ¯é—´ï¼‰</label>
                <select id="roiPack" class="field">
                  <option value="basic">åŸºç¡€åŒ…ï¼šé—¨é”+ç½‘å…³</option>
                  <option value="std" selected>æ ‡å‡†åŒ…ï¼šé—¨é”+ç¯å…‰+ç©ºè°ƒ+ç½‘å…³</option>
                  <option value="pro">æ——èˆ°åŒ…ï¼šæ ‡å‡†åŒ…+æ´—è¡£è”åŠ¨+èƒ½è€—ç­–ç•¥</option>
                </select>
              </div>
              <div>
                <label>ä¸€æ¬¡æ€§ç¡¬ä»¶æŠ•å…¥ï¼ˆå…ƒ/æˆ¿ï¼‰</label>
                <div class="sliderRow">
                  <input id="roiCapex" type="range" min="200" max="2000" step="50" value="900" />
                  <div class="num" id="roiCapexVal">900</div>
                </div>
              </div>
              <div>
                <label>å¹³å°æœåŠ¡è´¹ï¼ˆå…ƒ/æˆ¿/æœˆï¼‰</label>
                <div class="sliderRow">
                  <input id="roiSaaS" type="range" min="0" max="60" step="1" value="18" />
                  <div class="num" id="roiSaaSVal">18</div>
                </div>
              </div>
              <div>
                <label>èŠ‚çœäººåŠ›ï¼ˆäºº/100æˆ¿ï¼‰</label>
                <div class="sliderRow">
                  <input id="roiLaborSave" type="range" min="0" max="8" step="0.5" value="2.0" />
                  <div class="num" id="roiLaborSaveVal">2.0</div>
                </div>
              </div>
              <div>
                <label>äººåŠ›ç»¼åˆæˆæœ¬ï¼ˆå…ƒ/äºº/æœˆï¼‰</label>
                <div class="sliderRow">
                  <input id="roiLaborCost" type="range" min="5000" max="18000" step="500" value="9000" />
                  <div class="num" id="roiLaborCostVal">9000</div>
                </div>
              </div>
              <div>
                <label>èŠ‚èƒ½æ”¶ç›Šï¼ˆå…ƒ/æˆ¿/æœˆï¼‰</label>
                <div class="sliderRow">
                  <input id="roiEnergy" type="range" min="0" max="50" step="1" value="12" />
                  <div class="num" id="roiEnergyVal">12</div>
                </div>
              </div>
              <div>
                <label>è¿ç»´æˆæœ¬ï¼ˆå…ƒ/æˆ¿/æœˆï¼‰</label>
                <div class="sliderRow">
                  <input id="roiOpex" type="range" min="0" max="20" step="1" value="3" />
                  <div class="num" id="roiOpexVal">3</div>
                </div>
              </div>
            </div>
            <div class="note">
              ROI å£å¾„ï¼š<span class="mono">äººåŠ›èŠ‚çœ + èŠ‚èƒ½æ”¶ç›Š - å¹³å°è´¹ - è¿ç»´æˆæœ¬</span> ä¸ºæœˆå‡€æ”¶ç›Šï¼›CAPEX ä¸ºä¸€æ¬¡æ€§æŠ•å…¥ã€‚åŠ ç›Ÿå•†å†³ç­–è¦ç‚¹é€šå¸¸æ˜¯â€œå›æœ¬å‘¨æœŸ + å¯å¤åˆ¶è¿è¥SOP + ä½å®¢ä½“éªŒå£ç¢‘â€ã€‚
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const nowTs = ()=> new Date().toISOString().replace("T"," ").slice(0,19);
  const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
  const rand = (a,b)=> a + Math.random()*(b-a);
  const randInt = (a,b)=> Math.floor(rand(a,b+1));
  const choice = (arr)=> arr[Math.floor(Math.random()*arr.length)];
  const fmtMoney = (n)=> Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  const escapeHTML = (s)=> String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.classList.remove("show"), 1800);
  }

  const HOTELS = [
    {code:"HZ-SH-HQ", name:"å…¨å­£Â·ä¸Šæµ·è™¹æ¡¥æ¢çº½åº—", city:"ä¸Šæµ·", brand:"å…¨å­£"},
    {code:"HZ-SH-PD", name:"æ±‰åº­Â·ä¸Šæµ·æµ¦ä¸œæœºåœºåº—", city:"ä¸Šæµ·", brand:"æ±‰åº­"},
    {code:"HZ-HZ-XH", name:"æ¡”å­Â·æ­å·è¥¿æ¹–åº—", city:"æ­å·", brand:"æ¡”å­"},
    {code:"HZ-NJ-XJ", name:"å…¨å­£Â·å—äº¬æ–°è¡—å£åº—", city:"å—äº¬", brand:"å…¨å­£"},
    {code:"HZ-CD-TF", name:"ä½ å¥½Â·æˆéƒ½å¤©åºœå¹¿åœºåº—", city:"æˆéƒ½", brand:"ä½ å¥½"}
  ];

  const CATS = [
    {k:"LOCK", name:"æ™ºèƒ½é—¨é”"},
    {k:"HVAC", name:"ç©ºè°ƒ"},
    {k:"LIGHT", name:"ç¯å…‰"},
    {k:"LAUNDRY", name:"æ´—è¡£æœº"},
    {k:"GATEWAY", name:"ç½‘å…³"}
  ];

  const STATUS = ["ONLINE","OFFLINE","DEGRADED"];
  const VENDORS = ["Aqara","Tuya","Kaadas","Philips","Midea","Gree","Haier","Huawei","Zigbee-GW","BLE-GW"];
  const NET = ["Zigbee","BLE Mesh","Wiâ€‘Fi","Modbus","MQTT"];
  const ALERT_TYPES = [
    "é—¨é”ç”µé‡ä½", "é—¨é”ç¦»çº¿", "ç©ºè°ƒé€šè®¯å¼‚å¸¸", "ç¯å…‰å›è·¯æ•…éšœ", "æ´—è¡£æœºå ç”¨å¼‚å¸¸", "ç½‘å…³ç¦»çº¿", "å›ºä»¶ç‰ˆæœ¬è½å", "èƒ½è€—å¼‚å¸¸ï¼ˆå¤œé—´æœªå…³æœºï¼‰"
  ];
  const SEV = ["P1","P2","P3"];
  const WO_TYPES = ["è¿œç¨‹è¯Šæ–­","ç°åœºå·¡æ£€","æ›´æ¢ç”µæ± ","æ›´æ¢ç½‘å…³","å›ºä»¶å‡çº§","å‚æ•°æ ¡å‡†","èƒ½è€—ç­–ç•¥ä¸‹å‘"];

  function tagStatus(st){
    if(st==="ONLINE") return `<span class="tag good"><span class="s"></span>åœ¨çº¿</span>`;
    if(st==="OFFLINE") return `<span class="tag bad"><span class="s"></span>ç¦»çº¿</span>`;
    return `<span class="tag warn"><span class="s"></span>é™çº§</span>`;
  }
  function tagSev(s){
    if(s==="P1") return `<span class="tag bad"><span class="s"></span>P1</span>`;
    if(s==="P2") return `<span class="tag warn"><span class="s"></span>P2</span>`;
    return `<span class="tag"><span class="s"></span>P3</span>`;
  }
  function tagCat(k){
    const m = {LOCK:"é—¨é”",HVAC:"ç©ºè°ƒ",LIGHT:"ç¯å…‰",LAUNDRY:"æ´—è¡£",GATEWAY:"ç½‘å…³"};
    return `<span class="tag"><span class="s"></span>${m[k]||k}</span>`;
  }
  function tagWO(st){
    if(st==="NEW") return `<span class="tag warn"><span class="s"></span>æ–°å»º</span>`;
    if(st==="IN_PROGRESS") return `<span class="tag good"><span class="s"></span>å¤„ç†ä¸­</span>`;
    if(st==="WAITING") return `<span class="tag warn"><span class="s"></span>ç­‰å¾…ä¸­</span>`;
    return `<span class="tag"><span class="s"></span>å·²å®Œæˆ</span>`;
  }

  function genRooms(hotel, roomsCount){
    const out = [];
    for(let i=1;i<=roomsCount;i++){
      const floor = Math.floor((i-1)/20)+3;
      const num = String(i%100).padStart(2,"0");
      out.push({hotelCode:hotel.code, hotelName:hotel.name, room:`${floor}${num}`});
    }
    return out;
  }

  function genDevices(){
    const out = [];
    const hotelRooms = new Map();
    HOTELS.forEach(h=>{
      const rc = randInt(80, 220);
      hotelRooms.set(h.code, genRooms(h, rc));
    });

    let seq = 10000;

    for(const h of HOTELS){
      const rooms = hotelRooms.get(h.code);
      // gateway per 12 rooms approx
      const gwCount = Math.max(6, Math.round(rooms.length/12));
      for(let g=0; g<gwCount; g++){
        const st = choice(STATUS);
        out.push({
          id: `DEV-${seq++}`,
          hotelCode: h.code,
          hotel: h.name,
          brand: h.brand,
          city: h.city,
          room: `æœºæˆ¿/å¼±ç”µé—´-${randInt(1,6)}`,
          category: "GATEWAY",
          vendor: choice(VENDORS.filter(v=>v.includes("GW")||v.includes("Huawei")||v.includes("Tuya")||v.includes("Zigbee"))),
          protocol: choice(["MQTT","Zigbee","BLE Mesh"]),
          status: st,
          health: clamp(Math.round(60 + rand(0,40) - (st==="DEGRADED"?20:0) - (st==="OFFLINE"?35:0)), 0, 100),
          battery: null,
          firmware: choice(["v1.2.1","v1.2.3","v1.3.0","v1.3.2"]),
          lastSeen: st==="OFFLINE" ? `${randInt(20,240)} åˆ†é’Ÿå‰` : `${randInt(1,12)} åˆ†é’Ÿå‰`,
          notes: choice([
            "å»ºè®®æ£€æŸ¥ä¸Šè”äº¤æ¢æœºç«¯å£ä¸PoEä¾›ç”µã€‚",
            "å»ºè®®å¼€å¯ç¦»çº¿ç¼“å­˜ä¸é‡è¿ç­–ç•¥ã€‚",
            "å»ºè®®ç»Ÿä¸€å›ºä»¶ç‰ˆæœ¬ï¼Œé™ä½é—¨åº—è¿ç»´å¤æ‚åº¦ã€‚",
            "å»ºè®®å°†å¼‚å¸¸èƒ½è€—ç­–ç•¥é»˜è®¤ä¸‹å‘åˆ°å¤œé—´æ—¶æ®µã€‚"
          ])
        });
      }

      // per room: lock + hvac + light, laundry in shared area
      rooms.forEach(r=>{
        const lockSt = choice(STATUS);
        const hvacSt = choice(STATUS);
        const lightSt = choice(STATUS);

        out.push({
          id: `DEV-${seq++}`,
          hotelCode: h.code, hotel: h.name, brand: h.brand, city: h.city,
          room: r.room,
          category: "LOCK",
          vendor: choice(["Kaadas","Aqara","Tuya"]),
          protocol: choice(["BLE","Zigbee"]),
          status: lockSt,
          health: clamp(Math.round(65 + rand(0,35) - (lockSt==="DEGRADED"?18:0) - (lockSt==="OFFLINE"?35:0)), 0, 100),
          battery: clamp(Math.round(25 + rand(0,75) - (lockSt==="OFFLINE"?10:0)), 0, 100),
          firmware: choice(["v3.6.1","v3.6.3","v3.7.0","v3.7.2"]),
          lastSeen: lockSt==="OFFLINE" ? `${randInt(30,360)} åˆ†é’Ÿå‰` : `${randInt(1,15)} åˆ†é’Ÿå‰`,
          notes: choice([
            "å¯è”åŠ¨ PMSï¼šå…¥ä½â†’ä¸‹å‘ç”µå­é’¥åŒ™ï¼›é€€æˆ¿â†’å›æ”¶æƒé™ã€‚",
            "å»ºè®®è®¾ç½®ä½ç”µé‡é˜ˆå€¼ä¸æå‰æ´¾å•æ›´æ¢ç”µæ± ã€‚",
            "å»ºè®®å¯ç”¨â€œå¼‚å¸¸å¼€é—¨â€å®¡è®¡ä¸é»‘åå•ç­–ç•¥ã€‚"
          ])
        });

        out.push({
          id: `DEV-${seq++}`,
          hotelCode: h.code, hotel: h.name, brand: h.brand, city: h.city,
          room: r.room,
          category: "HVAC",
          vendor: choice(["Midea","Gree","Haier","Tuya"]),
          protocol: choice(["Modbus","Wiâ€‘Fi","MQTT"]),
          status: hvacSt,
          health: clamp(Math.round(60 + rand(0,40) - (hvacSt==="DEGRADED"?22:0) - (hvacSt==="OFFLINE"?35:0)), 0, 100),
          battery: null,
          firmware: choice(["v2.1.0","v2.1.4","v2.2.0","v2.2.3"]),
          lastSeen: hvacSt==="OFFLINE" ? `${randInt(10,180)} åˆ†é’Ÿå‰` : `${randInt(1,10)} åˆ†é’Ÿå‰`,
          notes: choice([
            "å»ºè®®ç»‘å®šå…¥ä½æ€ï¼šæ— äººâ†’èŠ‚èƒ½æ¨¡å¼ï¼›æœ‰äººâ†’èˆ’é€‚æ¨¡å¼ã€‚",
            "å»ºè®®ç»Ÿä¸€æ¸©åº¦ä¸Šé™ï¼Œé™ä½èƒ½è€—ä¸æŠ•è¯‰é£é™©ã€‚",
            "å»ºè®®å°†ç©ºè°ƒç¦»çº¿ä¸èƒ½è€—å¼‚å¸¸è‡ªåŠ¨è½¬å·¥å•ã€‚"
          ])
        });

        out.push({
          id: `DEV-${seq++}`,
          hotelCode: h.code, hotel: h.name, brand: h.brand, city: h.city,
          room: r.room,
          category: "LIGHT",
          vendor: choice(["Philips","Aqara","Tuya"]),
          protocol: choice(["Zigbee","BLE Mesh"]),
          status: lightSt,
          health: clamp(Math.round(70 + rand(0,30) - (lightSt==="DEGRADED"?16:0) - (lightSt==="OFFLINE"?35:0)), 0, 100),
          battery: null,
          firmware: choice(["v1.0.8","v1.1.0","v1.1.3","v1.2.0"]),
          lastSeen: lightSt==="OFFLINE" ? `${randInt(10,240)} åˆ†é’Ÿå‰` : `${randInt(1,12)} åˆ†é’Ÿå‰`,
          notes: choice([
            "å»ºè®®é…ç½®â€œå¤œé—´å…³æ€€â€ä¸â€œèµ·å¤œä½äº®â€åœºæ™¯ã€‚",
            "å»ºè®®å°†å›è·¯æ•…éšœä¸é¢‘é—ªè‡ªåŠ¨æ´¾å•ç»™å·¥ç¨‹éƒ¨ã€‚",
            "å»ºè®®ä¸é—¨ç£è”åŠ¨ï¼Œæå‡ä½å®¢ä½“éªŒã€‚"
          ])
        });
      });

      // laundry shared: 8-16 units
      const laundryCount = randInt(8,16);
      for(let i=0;i<laundryCount;i++){
        const st = choice(STATUS);
        out.push({
          id: `DEV-${seq++}`,
          hotelCode: h.code, hotel: h.name, brand: h.brand, city: h.city,
          room: `å…¬å…±æ´—è¡£æˆ¿-${randInt(1,2)}`,
          category: "LAUNDRY",
          vendor: choice(["Haier","Midea","Tuya"]),
          protocol: choice(["Wiâ€‘Fi","MQTT"]),
          status: st,
          health: clamp(Math.round(55 + rand(0,45) - (st==="DEGRADED"?20:0) - (st==="OFFLINE"?35:0)), 0, 100),
          battery: null,
          firmware: choice(["v4.0.1","v4.0.3","v4.1.0"]),
          lastSeen: st==="OFFLINE" ? `${randInt(5,120)} åˆ†é’Ÿå‰` : `${randInt(1,8)} åˆ†é’Ÿå‰`,
          notes: choice([
            "å»ºè®®å¼€æ”¾æ‰«ç é¢„çº¦ä¸æ’é˜Ÿæç¤ºï¼Œå‡å°‘å‰å°å’¨è¯¢ã€‚",
            "å»ºè®®è”åŠ¨æ•…éšœå‘Šè­¦â†’è‡ªåŠ¨é€€æ¬¾/è¡¥å¿åˆ¸ç­–ç•¥ï¼ˆéœ€ä¸šåŠ¡ç¡®è®¤ï¼‰ã€‚",
            "å»ºè®®ç»Ÿè®¡å³°å€¼ä½¿ç”¨ç‡ï¼ŒæŒ‡å¯¼è®¾å¤‡å¢é…ä¸èƒ½è€—æ²»ç†ã€‚"
          ])
        });
      }
    }

    return out;
  }

  function genHotelFleet(devices){
    const byHotel = new Map();
    devices.forEach(d=>{
      const key = d.hotelCode;
      if(!byHotel.has(key)){
        const h = HOTELS.find(x=>x.code===key);
        byHotel.set(key, {
          hotelCode: key,
          hotel: h.name,
          brand: h.brand,
          city: h.city,
          devices: 0, online: 0, offline: 0, degraded: 0,
          coverage: 0,
          alertsOpen: 0,
          energyRisk: 0
        });
      }
      const row = byHotel.get(key);
      row.devices += 1;
      if(d.status==="ONLINE") row.online += 1;
      if(d.status==="OFFLINE") row.offline += 1;
      if(d.status==="DEGRADED") row.degraded += 1;
    });

    // mock coverage + open alerts + energy risk
    for(const row of byHotel.values()){
      row.coverage = clamp(Math.round(78 + rand(0,20) - (row.offline>30?8:0)), 40, 99);
      row.alertsOpen = clamp(Math.round(6 + rand(0,18) + (row.offline>25?8:0)), 0, 60);
      row.energyRisk = clamp(Math.round(3 + rand(0,18) + (row.coverage>90? -2:2)), 0, 40);
    }
    return Array.from(byHotel.values());
  }

  function genAlerts(devices){
    const n = randInt(26, 55);
    const out = [];
    for(let i=0;i<n;i++){
      const d = choice(devices);
      const type = choice(ALERT_TYPES);
      const sev = choice(SEV);
      const ageMin = randInt(1, 360);
      const st = choice(["OPEN","ACK","CLOSED"]);
      const msg = (function(){
        if(type==="é—¨é”ç”µé‡ä½") return "ç”µé‡ä½äºé˜ˆå€¼ï¼Œå»ºè®®é›†ä¸­æ´¾å•æ›´æ¢ç”µæ± ï¼Œé¿å…å‡Œæ™¨æŠ•è¯‰ã€‚";
        if(type==="é—¨é”ç¦»çº¿") return "é—¨é”å¿ƒè·³ä¸¢å¤±ï¼Œå»ºè®®æ£€æŸ¥ç½‘å…³ä¿¡å·ä¸é—¨ç¦çº¿è·¯ã€‚";
        if(type==="ç©ºè°ƒé€šè®¯å¼‚å¸¸") return "é€šè®¯è¶…æ—¶ï¼Œå»ºè®®å¤æ ¸åè®®ç½‘å…³/åœ°å€ç /ç°åœºç”µæ§ã€‚";
        if(type==="ç¯å…‰å›è·¯æ•…éšœ") return "ç–‘ä¼¼å›è·¯å¼‚å¸¸æˆ–é©±åŠ¨æ•…éšœï¼Œå»ºè®®å·¥ç¨‹éƒ¨ç°åœºæ’æŸ¥ã€‚";
        if(type==="æ´—è¡£æœºå ç”¨å¼‚å¸¸") return "å ç”¨æ—¶é—´å¼‚å¸¸åé•¿ï¼Œå»ºè®®å¤æ ¸ä¼ æ„Ÿå™¨çŠ¶æ€ä¸è®¡è´¹é€»è¾‘ã€‚";
        if(type==="ç½‘å…³ç¦»çº¿") return "ç½‘å…³ç¦»çº¿å½±å“æ•´å±‚è®¾å¤‡ï¼Œå»ºè®®ä¼˜å…ˆæ¢å¤ç½‘ç»œä¸ä¾›ç”µã€‚";
        if(type==="å›ºä»¶ç‰ˆæœ¬è½å") return "å›ºä»¶è½åå­˜åœ¨å…¼å®¹é£é™©ï¼Œå»ºè®®å®‰æ’ä½å³°æ—¶æ®µå‡çº§çª—å£ã€‚";
        return "å¤œé—´èƒ½è€—å¼‚å¸¸ï¼Œå»ºè®®å¯ç”¨é€€æˆ¿èŠ‚èƒ½/æ— äººå…³æœºç­–ç•¥ã€‚";
      })();

      out.push({
        id: "ALT-" + (9000+i),
        hotelCode: d.hotelCode,
        hotel: d.hotel,
        room: d.room,
        deviceId: d.id,
        category: d.category,
        type, sev,
        status: st,
        created: `${ageMin} åˆ†é’Ÿå‰`,
        msg
      });
    }
    const sevRank = {P1:1,P2:2,P3:3};
    out.sort((a,b)=> sevRank[a.sev]-sevRank[b.sev]);
    return out;
  }

  function genWorkOrders(alerts){
    const out = [];
    const m = randInt(18, 36);
    for(let i=0;i<m;i++){
      const a = choice(alerts);
      const type = choice(WO_TYPES);
      const state = choice(["NEW","IN_PROGRESS","WAITING","DONE"]);
      const ageH = randInt(1, 96);
      out.push({
        id: "WO-" + (7000+i),
        hotelCode: a.hotelCode,
        hotel: a.hotel,
        room: a.room,
        deviceId: a.deviceId,
        category: a.category,
        priority: choice(["P1","P2","P3"]),
        state,
        owner: choice(["å·¥ç¨‹éƒ¨","å€¼ç­ç»ç†","ä¾›åº”å•†é©»åœº","è¿œç¨‹æ”¯æŒ"]),
        sla: choice(["2h","4h","8h","24h","48h"]),
        updated: `${ageH} å°æ—¶å‰`,
        title: `${type} Â· ${a.type}`,
        desc: `å…³è”å‘Šè­¦ ${a.id}ï¼ˆ${a.type}/${a.sev}ï¼‰ã€‚å»ºè®®æŒ‰é…’åº—SOPæ‰§è¡Œï¼šè¿œç¨‹è¯Šæ–­â†’ç°åœºå¤„ç½®â†’å›å†™ç»“æœâ†’å…³é—­å‘Šè­¦ã€‚`
      });
    }
    return out;
  }

  let state = {
    view: "fleet",
    theme: "dark",
    q: "",
    filterBrand: "ALL",
    filterPremium: "ALL",
    filterHotel: "ALL",
    filterCategory: "ALL",
    selected: null,
    devices: [],
    fleet: [],
    alerts: [],
    workorders: [],
    premiumByHotel: {} // {hotelCode:{sleep:boolean, ar:boolean}}
  };

  const VIEW_META = {
    fleet: {
      title: "èµ„äº§æ€»è§ˆ",
      subtitle: "ç»Ÿä¸€çœ‹æ¿èšåˆå„é…’åº— IoT è¦†ç›–ç‡ã€åœ¨çº¿ç‡ä¸å…³é”®å‘Šè­¦ã€‚ç‚¹å‡»è¡Œå¯çœ‹é…’åº—çº§æ˜ç»†ï¼Œå¹¶è§¦å‘æ´¾å•ä¸æ²»ç†åŠ¨ä½œï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚",
      columns: [
        {key:"hotel", label:"é…’åº—", render:(r)=> `<span>${escapeHTML(r.hotel)}</span><div class="muted" style="font-size:12px;margin-top:2px;">${escapeHTML(r.city)} Â· ${escapeHTML(r.brand)} Â· ${escapeHTML(r.hotelCode)}</div>`},
        {key:"coverage", label:"è¦†ç›–ç‡", render:(r)=> `<span class="mono">${r.coverage}%</span>`},
        {key:"online", label:"åœ¨çº¿è®¾å¤‡", render:(r)=> `<span class="mono">${r.online}</span>`},
        {key:"offline", label:"ç¦»çº¿", render:(r)=> `<span class="mono">${r.offline}</span>`},
        {key:"degraded", label:"é™çº§", render:(r)=> `<span class="mono">${r.degraded}</span>`},
        {key:"alertsOpen", label:"æœªé—­ç¯å‘Šè­¦", render:(r)=> `<span class="mono">${r.alertsOpen}</span>`},
        {key:"energyRisk", label:"èƒ½è€—é£é™©", render:(r)=> `<span class="mono">${r.energyRisk}</span>`}
      ],
      kpis: (rows)=>{
        const hotels = rows.length;
        const cov = rows.length? rows.reduce((s,r)=>s+r.coverage,0)/rows.length : 0;
        const online = rows.reduce((s,r)=>s+r.online,0);
        const offline = rows.reduce((s,r)=>s+r.offline,0);
        const openAlerts = rows.reduce((s,r)=>s+r.alertsOpen,0);
        return [
          {label:"é…’åº—æ•°", value: hotels, hint:"æŒ‰å“ç‰Œ/åŒºåŸŸå¯ç»§ç»­æ‹†åˆ†", dot:""},
          {label:"å¹³å‡è¦†ç›–ç‡", value: Math.round(cov) + "%", hint:"è®¾å¤‡ä¸Šäº‘ä¸è”åŠ¨èƒ½åŠ›çš„åŸºç¡€", dot:"good"},
          {label:"ç¦»çº¿è®¾å¤‡", value: offline, hint:"å½±å“ä½“éªŒä¸SOPæ‰§è¡Œï¼Œå»ºè®®å…ˆæ²»ç†ç½‘ç»œ/ç½‘å…³", dot:"bad"},
          {label:"æœªé—­ç¯å‘Šè­¦", value: openAlerts, hint:"æ ¸å¿ƒè€ƒæ ¸ï¼šå‘Šè­¦â†’å·¥å•â†’å›å†™é—­ç¯", dot:"warn"}
        ];
      }
    },
    devices: {
      title: "è®¾å¤‡ä¸­å¿ƒ",
      subtitle: "æŒ‰é…’åº—/æˆ¿é—´/å“ç±»ç®¡ç†æ™ºèƒ½é—¨é”ã€ç©ºè°ƒã€ç¯å…‰ã€æ´—è¡£ä¸ç½‘å…³ã€‚ç‚¹å‡»è®¾å¤‡æŸ¥çœ‹å³ä¾§è¯¦æƒ…å¹¶å¯è§¦å‘â€œæ´¾å•/å›ºä»¶å‡çº§/æ‰§è¡Œåœºæ™¯â€ã€‚",
      columns: [
        {key:"id", label:"è®¾å¤‡ID", render:(r)=> `<span class="mono">${r.id}</span>`},
        {key:"hotel", label:"é…’åº—"},
        {key:"room", label:"æˆ¿é—´/åŒºåŸŸ", render:(r)=> `<span class="mono">${escapeHTML(r.room)}</span>`},
        {key:"category", label:"å“ç±»", render:(r)=> tagCat(r.category)},
        {key:"status", label:"çŠ¶æ€", render:(r)=> tagStatus(r.status)},
        {key:"health", label:"å¥åº·åº¦", render:(r)=> `<span class="mono">${r.health}</span>`},
        {key:"battery", label:"ç”µé‡", render:(r)=> r.battery===null ? "<span class='muted'>â€”</span>" : `<span class="mono">${r.battery}%</span>`},
        {key:"protocol", label:"åè®®", render:(r)=> `<span class="mono">${escapeHTML(r.protocol)}</span>`},
        {key:"firmware", label:"å›ºä»¶", render:(r)=> `<span class="mono">${escapeHTML(r.firmware)}</span>`},
        {key:"lastSeen", label:"æœ€è¿‘å¿ƒè·³"}
      ],
      kpis: (rows)=>{
        const online = rows.filter(r=>r.status==="ONLINE").length;
        const off = rows.filter(r=>r.status==="OFFLINE").length;
        const deg = rows.filter(r=>r.status==="DEGRADED").length;
        const avgHealth = rows.length? rows.reduce((s,r)=>s+r.health,0)/rows.length:0;
        return [
          {label:"åœ¨çº¿è®¾å¤‡", value: online, hint:"ä¿éšœå®¢æˆ¿ä½“éªŒä¸è¿è¥SOP", dot:"good"},
          {label:"ç¦»çº¿è®¾å¤‡", value: off, hint:"ä¼˜å…ˆæ’æŸ¥ç½‘å…³/ç½‘ç»œ/ä¾›ç”µ", dot:"bad"},
          {label:"é™çº§è¿è¡Œ", value: deg, hint:"å‚æ•°/ä¿¡å·/å…¼å®¹é—®é¢˜", dot:"warn"},
          {label:"å¹³å‡å¥åº·åº¦", value: Math.round(avgHealth), hint:"ç”¨äºé—¨åº—æ²»ç†è¯„åˆ†", dot:""}
        ];
      }
    },
    scenes: {
      title: "åœºæ™¯è”åŠ¨",
      subtitle: "æŠŠâ€œè®¾å¤‡â€å‡çº§ä¸ºâ€œä½“éªŒâ€ï¼šå…¥ä½æ¬¢è¿ã€é€€æˆ¿èŠ‚èƒ½ã€å…æ‰“æ‰°ã€å¤œé—´å…³æ€€ã€è‡ªåŠ©æ´—è¡£ã€‚æ­¤å¤„æ¼”ç¤ºåœºæ™¯æ¨¡æ¿+å‚æ•°åŒ–é…ç½®+æ‰§è¡Œä¸å¯¼å‡ºã€‚",
      columns: [],
      kpis: ()=>[]
    },
    alerts: {
      title: "å‘Šè­¦ä¸­å¿ƒ",
      subtitle: "ç»Ÿä¸€èšåˆé—¨é”/ç©ºè°ƒ/ç¯å…‰/æ´—è¡£/ç½‘å…³å‘Šè­¦ï¼Œæ”¯æŒç¡®è®¤ï¼ˆACKï¼‰ã€ç”Ÿæˆå·¥å•ã€é—­ç¯å›å†™ã€‚å»ºè®®ä¸é—¨åº—è€ƒæ ¸ç»‘å®šå½¢æˆå¯æŒç»­æ²»ç†æœºåˆ¶ã€‚",
      columns: [
        {key:"id", label:"å‘Šè­¦ID", render:(r)=> `<span class="mono">${r.id}</span>`},
        {key:"sev", label:"ç­‰çº§", render:(r)=> tagSev(r.sev)},
        {key:"hotel", label:"é…’åº—"},
        {key:"room", label:"æˆ¿é—´/åŒºåŸŸ", render:(r)=> `<span class="mono">${escapeHTML(r.room)}</span>`},
        {key:"category", label:"å“ç±»", render:(r)=> tagCat(r.category)},
        {key:"type", label:"ç±»å‹"},
        {key:"deviceId", label:"è®¾å¤‡ID", render:(r)=> `<span class="mono">${r.deviceId}</span>`},
        {key:"status", label:"çŠ¶æ€", render:(r)=> alertStatusTag(r.status)},
        {key:"created", label:"å‘ç”Ÿæ—¶é—´"},
        {key:"msg", label:"æ‘˜è¦", render:(r)=> `<span class="muted">${escapeHTML(r.msg)}</span>`}
      ],
      kpis: (rows)=>{
        const open = rows.filter(r=>r.status==="OPEN").length;
        const ack = rows.filter(r=>r.status==="ACK").length;
        const p1 = rows.filter(r=>r.sev==="P1" && r.status!=="CLOSED").length;
        const byType = {};
        rows.forEach(r=> byType[r.type]=(byType[r.type]||0)+1 );
        const top = Object.entries(byType).sort((a,b)=>b[1]-a[1])[0];
        return [
          {label:"æœªå¤„ç†ï¼ˆOPENï¼‰", value: open, hint:"å€¼ç­ä¾§ä¼˜å…ˆæ‹‰é½", dot:"bad"},
          {label:"å·²ç¡®è®¤ï¼ˆACKï¼‰", value: ack, hint:"ç¡®è®¤åè¿›å…¥å¤„ç½®/è½¬å·¥å•", dot:"warn"},
          {label:"é«˜ä¼˜ï¼ˆP1ï¼‰", value: p1, hint:"å»ºè®®é»˜è®¤è½¬å·¥å•å¹¶å‡çº§SLA", dot:"bad"},
          {label:"Top å‘Šè­¦ç±»å‹", value: top? top[0]:"â€”", hint: top? `å‡ºç° ${top[1]} æ¬¡`:"æš‚æ— ", dot:""}
        ];
      }
    },
    workorders: {
      title: "å·¥å•",
      subtitle: "å·¥å•æ˜¯é…’åº— IoT è¿è¥çš„é—­ç¯è½½ä½“ï¼šSLAã€è´£ä»»äººã€è¿‡ç¨‹ä¸ç»“æœå›å†™ã€‚æ”¯æŒä»å‘Šè­¦/è®¾å¤‡ä¸€é”®ç”Ÿæˆï¼Œå½¢æˆå¯å®¡è®¡çš„è¿ç»´é“¾è·¯ã€‚",
      columns: [
        {key:"id", label:"å·¥å•ID", render:(r)=> `<span class="mono">${r.id}</span>`},
        {key:"priority", label:"ä¼˜å…ˆçº§", render:(r)=> tagSev(r.priority)},
        {key:"state", label:"çŠ¶æ€", render:(r)=> tagWO(r.state)},
        {key:"hotel", label:"é…’åº—"},
        {key:"room", label:"æˆ¿é—´/åŒºåŸŸ", render:(r)=> `<span class="mono">${escapeHTML(r.room)}</span>`},
        {key:"category", label:"å“ç±»", render:(r)=> tagCat(r.category)},
        {key:"title", label:"æ ‡é¢˜"},
        {key:"owner", label:"è´Ÿè´£äºº"},
        {key:"sla", label:"SLA", render:(r)=> `<span class="mono">${escapeHTML(r.sla)}</span>`},
        {key:"updated", label:"æœ€è¿‘æ›´æ–°"}
      ],
      kpis: (rows)=>{
        const n = rows.filter(r=>r.state==="NEW").length;
        const ip = rows.filter(r=>r.state==="IN_PROGRESS").length;
        const w = rows.filter(r=>r.state==="WAITING").length;
        const d = rows.filter(r=>r.state==="DONE").length;
        return [
          {label:"æ–°å»º", value: n, hint:"ç­‰å¾…å—ç†/åˆ†æ´¾", dot:"warn"},
          {label:"å¤„ç†ä¸­", value: ip, hint:"å·¥ç¨‹ä¸ä¾›åº”å•†ååŒ", dot:"good"},
          {label:"ç­‰å¾…ä¸­", value: w, hint:"å¤‡ä»¶/æƒé™/åˆ°åº—æ—¶çª—", dot:"warn"},
          {label:"å·²å®Œæˆ", value: d, hint:"é—­ç¯å›å†™æ‰æœ‰è¿è¥ä»·å€¼", dot:"good"}
        ];
      }
    },

    premium: {
      title: "é«˜ç«¯èƒ½åŠ›",
      subtitle: "ä»…é«˜ç«¯ä¸è¯•ç‚¹é—¨åº—å¯ç”³è¯·ï¼šæ™ºèƒ½ç¡çœ ç›‘æµ‹ç³»ç»Ÿã€AR çœ¼é•œç³»ç»Ÿã€‚éœ€æ€»éƒ¨å®¡æ‰¹åå¼€é€šï¼›å¼€é€šåï¼Œæ¨¡å—èƒ½åŠ›ä¸è¿è¥æŒ‡æ ‡æ‰ä¼šå‡ºç°åœ¨é—¨åº—ç•Œé¢ä¸æ²»ç†æŠ¥è¡¨ä¸­ã€‚",
      columns: [
        {key:"hotel", label:"é…’åº—", render:(r)=> `<span>${escapeHTML(r.hotel)}</span><div class="muted" style="font-size:12px;margin-top:2px;">${escapeHTML(r.city)} Â· ${escapeHTML(r.brand)} Â· ${escapeHTML(r.hotelCode)}</div>`},
        {key:"eligible", label:"æ˜¯å¦å¯ç”³è¯·", render:(r)=> r.eligible ? `<span class="tag good"><span class="s"></span>å¯ç”³è¯·</span>` : `<span class="tag"><span class="s"></span>æ ‡å‡†ç‰ˆ</span>`},
        {key:"sleep", label:"ç¡çœ ç³»ç»Ÿ", render:(r)=> r.sleep ? `<span class="tag good"><span class="s"></span>å·²å¼€é€š</span>` : `<span class="tag warn"><span class="s"></span>æœªå¼€é€š</span>`},
        {key:"ar", label:"AR çœ¼é•œ", render:(r)=> r.ar ? `<span class="tag good"><span class="s"></span>å·²å¼€é€š</span>` : `<span class="tag warn"><span class="s"></span>æœªå¼€é€š</span>`},
        {key:"govern", label:"æ²»ç†å»ºè®®", render:(r)=> `<span class="muted">${escapeHTML(r.govern)}</span>`}
      ],
      kpis: (rows)=>{
        const eligible = rows.filter(r=>r.eligible).length;
        const sleepOn = rows.filter(r=>r.sleep).length;
        const arOn = rows.filter(r=>r.ar).length;
        const both = rows.filter(r=>r.sleep && r.ar).length;
        return [
          {label:"å¯ç”³è¯·é—¨åº—", value: eligible, hint:"èŠ±é—´å ‚/å–œæ‚¦/é«˜ç«¯è¯•ç‚¹", dot:"good"},
          {label:"ç¡çœ å·²å¼€é€š", value: sleepOn, hint:"æ€»éƒ¨å®¡æ‰¹åæ‰å‡ºç°æ¨¡å—", dot:"warn"},
          {label:"AR å·²å¼€é€š", value: arOn, hint:"å·¥ç¨‹æ•ˆç‡ä¸VIPä½“éªŒåŒç”¨", dot:"warn"},
          {label:"åŒèƒ½åŠ›é½å¤‡", value: both, hint:"å¯å½¢æˆé«˜ç«¯ä½“éªŒé£è½®", dot:"good"}
        ];
      }
    },


    member: {
      title: "åä½ä¼šä¼šå‘˜ï¼ˆH Rewardsï¼‰",
      subtitle: "é›†å›¢çº§å¿ è¯šä½“ç³»ä¸ç›´è®¢ç”Ÿæ€å…¥å£ï¼šä¼šå‘˜ç­‰çº§ã€ç§¯åˆ†èµ„äº§ã€æƒç›Šç­–ç•¥ã€æ´»åŠ¨å¢é•¿ä¸é—¨åº—ä½“éªŒè”åŠ¨ã€‚è¯¥é¡µä¸ºæ¼”ç¤ºå£å¾„ï¼Œå¼ºè°ƒå¯è¿è¥ã€å¯è®¡é‡ã€å¯é—­ç¯ã€‚",
      columns: [
        {key:"seg", label:"äººç¾¤/ç­‰çº§", render:(r)=> `<span>${escapeHTML(r.seg)}</span><div class="muted" style="font-size:12px;margin-top:2px;">${escapeHTML(r.desc)}</div>`},
        {key:"value", label:"æ ¸å¿ƒæƒç›Š/ä»·å€¼", render:(r)=> `<span class="muted">${escapeHTML(r.value)}</span>`},
        {key:"kpi", label:"è¿è¥æŒ‡æ ‡", render:(r)=> `<span class="mono">${escapeHTML(r.kpi)}</span>`},
        {key:"next", label:"ä¸‹ä¸€æ­¥åŠ¨ä½œ", render:(r)=> `<span class="muted">${escapeHTML(r.next)}</span>`}
      ],
      kpis:(rows)=>{
        const direct = 0.65; // demo: ç›´è®¢å æ¯”
        const act = 0.42;    // demo: æ´»è·ƒç‡
        const rep = 0.28;    // demo: å¤è´­ç‡
        const nps = 53;      // demo: NPS
        return [
          {label:"ç›´è®¢å æ¯”", value: Math.round(direct*100) + "%", hint:"App/å°ç¨‹åº/å®˜ç½‘", dot:"good"},
          {label:"æœˆæ´»è·ƒç‡", value: Math.round(act*100) + "%", hint:"ä¼šå‘˜è§¦è¾¾ä¸è½¬åŒ–", dot:"warn"},
          {label:"å¤è´­ç‡", value: Math.round(rep*100) + "%", hint:"è·¨å“ç‰Œå¤ä½", dot:"good"},
          {label:"ä¼šå‘˜ NPS", value: nps, hint:"æœåŠ¡ä¸€è‡´æ€§ä¸ä½“éªŒ", dot:"good"}
        ];
      }
    },

    roi: {
      title: "åŠ ç›Ÿ ROI",
      subtitle: "ç”¨åŠ ç›Ÿå•†èƒ½å¬æ‡‚çš„è¯­è¨€ï¼šä¸€æ¬¡æ€§æŠ•å…¥ã€æ¯æœˆå‡€æ”¶ç›Šã€å›æœ¬å‘¨æœŸä¸ä¸‰å¹´å‡€æ”¶ç›Šã€‚è®©â€œä¹°è®¾å¤‡â€å˜æˆâ€œä¹°ä½“éªŒ+ä¹°è¿è¥èƒ½åŠ›â€ã€‚",
      columns: [],
      kpis: ()=>[]
    }
  };

  function alertStatusTag(s){
    if(s==="OPEN") return `<span class="tag bad"><span class="s"></span>æœªå¤„ç†</span>`;
    if(s==="ACK") return `<span class="tag warn"><span class="s"></span>å·²ç¡®è®¤</span>`;
    return `<span class="tag good"><span class="s"></span>å·²å…³é—­</span>`;
  }

  function updateBadges(){
    $("badgeHotels").textContent = state.fleet.length;
    $("badgeDevices").textContent = state.devices.length;
    $("badgeAlerts").textContent = state.alerts.filter(a=>a.status!=="CLOSED").length;
    $("badgeWO").textContent = state.workorders.filter(w=>w.state!=="DONE").length;
    $("badgePremium").textContent = "éœ€å®¡æ‰¹";
    const direct = 65;
    if($("badgeMember")) $("badgeMember").textContent = direct + "%ç›´è®¢";
  }

  function populateFilters(){
    // Brand / premium filters
    if($("filterBrand")) $("filterBrand").value = state.filterBrand || "ALL";
    if($("filterPremium")) $("filterPremium").value = state.filterPremium || "ALL";

    const hotelSel = $("filterHotel");
    hotelSel.innerHTML = `<option value="ALL">å…¨éƒ¨</option>` + HOTELS.map(h=>`<option value="${h.code}">${escapeHTML(h.name)}</option>`).join("");
    hotelSel.value = state.filterHotel;

    // Bind brand/premium filters
    const fbSel = $("filterBrand");
    const fpSel = $("filterPremium");
    if(fbSel) fbSel.addEventListener("change", ()=>{ state.filterBrand = fbSel.value; render(); });
    if(fpSel) fpSel.addEventListener("change", ()=>{ state.filterPremium = fpSel.value; render(); });

    // scenes room list: default first hotel rooms from devices
    const rooms = Array.from(new Set(state.devices.filter(d=>d.category!=="GATEWAY").map(d=>`${d.hotelCode}ï½œ${d.room}`))).slice(0, 240).sort();
    const roomSel = $("sceneRoom");
    roomSel.innerHTML = rooms.map(x=>`<option value="${escapeHTML(x)}">${escapeHTML(x)}</option>`).join("");
  }

  function applyFilters(rows){
    const q = state.q.trim().toLowerCase();
    let out = rows;

    const fb = $("filterBrand") ? $("filterBrand").value : (state.filterBrand||"ALL");
    const fp = $("filterPremium") ? $("filterPremium").value : (state.filterPremium||"ALL");

    if(fb !== "ALL"){
      out = out.filter(r => (r.brand||"") === fb);
    }

    if(state.filterHotel !== "ALL"){
      out = out.filter(r => (r.hotelCode||"") === state.filterHotel);
    }

    if(fp !== "ALL"){
      out = out.filter(r=>{
        const code = r.hotelCode || (r.hotelCode===0? "": "");
        if(!code || !state.premiumByHotel) return (fp==="OFF"); // if unknown, treat as OFF
        const p = state.premiumByHotel[code] || {sleep:false, ar:false};
        const on = !!(p.sleep || p.ar);
        return fp==="ON" ? on : !on;
      });
    }

    if(state.filterCategory !== "ALL"){
      // only applies when row has category
      out = out.filter(r => (r.category||"") === state.filterCategory);
    }

    if(q){
      out = out.filter(r => Object.values(r).join(" ").toLowerCase().includes(q));
    }
    return out;
  }

  const PREMIUM_BRANDS = new Set(["èŠ±é—´å ‚","å–œæ‚¦"]);
  function isPremiumEligibleBrand(brand){ return PREMIUM_BRANDS.has(brand); }

  function currentRows(){


    if(state.view==="member"){
      const r = state.selected;
      d.innerHTML = `
        <h4>${escapeHTML(r.seg)}</h4>
        <p class="muted">${escapeHTML(r.desc)}</p>
        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:12px 0;">
        <p><span class="muted">æ ¸å¿ƒæƒç›Š/ä»·å€¼ï¼š</span>${escapeHTML(r.value)}</p>
        <p><span class="muted">å…³é”®æŒ‡æ ‡ï¼š</span><span class="mono">${escapeHTML(r.kpi)}</span></p>
        <p><span class="muted">å»ºè®®åŠ¨ä½œï¼š</span>${escapeHTML(r.next)}</p>
        <div class="row" style="margin-top:10px;">
          <span class="chip" id="goDevices">è”åŠ¨ IoT è®¾å¤‡</span>
          <span class="chip" id="goPremium">è”åŠ¨é«˜ç«¯èƒ½åŠ›</span>
          <span class="chip" id="copyOps">å¤åˆ¶è¿è¥è¯æœ¯</span>
        </div>
        <p class="note">æ¼”ç¤ºï¼šå°†ä¼šå‘˜ç­–ç•¥ä¸é—¨åº—èƒ½åŠ›ï¼ˆé—¨é”/ç©ºè°ƒ/æ´—è¡£/ç¡çœ /ARï¼‰ç»‘å®šï¼Œå½¢æˆâ€œå¯å”®å–æƒç›ŠåŒ…â€å’Œâ€œå¯é‡åŒ–SLAâ€ã€‚</p>
      `;
      $("goDevices")?.addEventListener("click", ()=>{ state.view="devices"; render(); toast("å·²åˆ‡æ¢åˆ°è®¾å¤‡ä¸­å¿ƒ"); });
      $("goPremium")?.addEventListener("click", ()=>{ state.view="premium"; render(); toast("å·²åˆ‡æ¢åˆ°é«˜ç«¯èƒ½åŠ›"); });
      $("copyOps")?.addEventListener("click", async ()=>{
        const txt = `æˆ‘ä»¬æŠŠåä½ä¼šä¼šå‘˜æƒç›Šåšæˆâ€œå¯äº¤ä»˜æœåŠ¡èƒ½åŠ›â€ï¼šé€šè¿‡é—¨é”/ç©ºè°ƒ/æ´—è¡£ç­‰ IoT ä¸å·¥å•SLAé—­ç¯ï¼Œç¡®ä¿æƒç›Šå…‘ç°ï¼›åœ¨èŠ±é—´å ‚/å–œæ‚¦è¯•ç‚¹ä¸Šçº¿ç¡çœ ä¸ARèƒ½åŠ›ï¼Œå½¢æˆé«˜ç«¯æˆ¿å‹æº¢ä»·ä¸å¤è´­é£è½®ã€‚`;
        try{ await navigator.clipboard.writeText(txt); toast("å·²å¤åˆ¶è¯æœ¯"); }catch(_){ toast("å¤åˆ¶å¤±è´¥ï¼ˆæƒé™é™åˆ¶ï¼‰"); }
      });
      return;
    }

    if(state.view==="premium"){
      const r = state.selected;
      const eligible = !!r.eligible;
      const p = state.premiumByHotel[r.hotelCode] || {sleep:false, ar:false};
      const lockMsg = eligible ? "" : "ï¼ˆè¯¥é—¨åº—ä¸ºæ ‡å‡†ç‰ˆï¼Œä¸æ”¯æŒç”³è¯·ï¼‰";
      d.innerHTML = `
        <h4>${escapeHTML(r.hotel)}</h4>
        <p><span class="muted">å“ç‰Œï¼š</span><span class="mono">${escapeHTML(r.brand)}</span> <span class="muted">åŸå¸‚ï¼š</span><span class="mono">${escapeHTML(r.city)}</span></p>
        <div class="row">
          ${eligible ? `<span class="tag good"><span class="s"></span>å¯ç”³è¯·</span>` : `<span class="tag"><span class="s"></span>æ ‡å‡†ç‰ˆ</span>`}
          ${p.sleep ? `<span class="tag good"><span class="s"></span>ç¡çœ ï¼šå·²å¼€é€š</span>` : `<span class="tag warn"><span class="s"></span>ç¡çœ ï¼šæœªå¼€é€š</span>`}
          ${p.ar ? `<span class="tag good"><span class="s"></span>ARï¼šå·²å¼€é€š</span>` : `<span class="tag warn"><span class="s"></span>ARï¼šæœªå¼€é€š</span>`}
        </div>
        <p style="margin-top:10px;"><span class="muted">æ€»éƒ¨å®¡æ‰¹åŠ¨ä½œï¼š</span>${escapeHTML(lockMsg)}</p>
        <div class="row">
          <span class="chip" id="approveSleep">${p.sleep ? "å…³é—­ç¡çœ ç³»ç»Ÿ" : "å®¡æ‰¹å¹¶å¼€å¯ç¡çœ ç³»ç»Ÿ"}</span>
          <span class="chip" id="approveAR">${p.ar ? "å…³é—­ AR ç³»ç»Ÿ" : "å®¡æ‰¹å¹¶å¼€å¯ AR ç³»ç»Ÿ"}</span>
          <span class="chip" id="goSleep">æŸ¥çœ‹ç¡çœ æ¨¡å—</span>
          <span class="chip" id="goAR">æŸ¥çœ‹ AR æ¨¡å—</span>
        </div>
        <p class="note">å®¡æ‰¹å¼€å¯åï¼šé—¨åº—ç«¯å°†å‡ºç°å¯¹åº”æ¨¡å—ï¼Œå¹¶çº³å…¥æ²»ç†æŒ‡æ ‡ã€å®¡è®¡æ—¥å¿—ä¸SLAä½“ç³»ï¼ˆæ¼”ç¤ºä¸ºå³æ—¶ç”Ÿæ•ˆï¼‰ã€‚</p>
      `;

      const toggle = (k)=>{
        if(!eligible){ toast("æ ‡å‡†ç‰ˆé—¨åº—ä¸æ”¯æŒé«˜ç«¯èƒ½åŠ›"); return; }
        state.premiumByHotel[r.hotelCode][k] = !state.premiumByHotel[r.hotelCode][k];
        // rebuild premium rows and rerender table/detail
        state.premiumRows = state.fleet.map(f=>{
          const eligible2 = isPremiumEligibleBrand(f.brand);
          const pp = state.premiumByHotel[f.hotelCode] || {sleep:false, ar:false};
          return {
            hotelCode: f.hotelCode, hotel: f.hotel, brand: f.brand, city: f.city,
            eligible: eligible2,
            sleep: !!pp.sleep, ar: !!pp.ar,
            govern: eligible2
              ? (pp.sleep||pp.ar ? "å»ºè®®å°†é«˜ç«¯èƒ½åŠ›ç»‘å®šæˆ¿å‹/æƒç›Šï¼Œå¹¶çº³å…¥å®¡è®¡æ—¥å¿—ã€‚" : "å»ºè®®å…ˆè¯•ç‚¹ 1-2 å®¶é—¨åº—ï¼Œå»ºç«‹å£å¾„ä¸SOPã€‚")
              : "æ ‡å‡†ç‰ˆé—¨åº—ä»¥ç¨³å®šä¸é™æœ¬ä¸ºä¼˜å…ˆã€‚"
          };
        });
    // Build member view rows (demo)
    state.memberRows = [
      {seg:"æ˜Ÿä¼šå‘˜ï¼ˆå…¥é—¨ï¼‰", desc:"æ‹‰æ–°/ä½é¢‘ï¼Œé‡è§†ä¾¿æ·ä¸ä»·æ ¼", value:"ä¼šå‘˜ä»·ã€ç§¯åˆ†ç´¯è®¡ã€åŸºç¡€å»¶è¿Ÿé€€æˆ¿ï¼ˆè§†å“ç‰Œæ”¿ç­–ï¼‰", kpi:"è½¬åŒ–ç‡ / é¦–ä½è½¬å¤ä½", next:"é¦–ä½ç¤¼åŒ… + å¼•å¯¼ç›´è®¢ï¼ˆå… OTAï¼‰"},
      {seg:"é“¶ä¼šå‘˜ï¼ˆæˆé•¿ï¼‰", desc:"å¼€å§‹è·¨å“ç‰Œï¼Œå¯¹æƒç›Šæ•æ„Ÿ", value:"æ›´é«˜ç§¯åˆ†å€ç‡ã€æ›´å¤šåˆ¸åŒ…ã€éƒ¨åˆ†æ—©é¤/å‡çº§æœºä¼š", kpi:"ç›´è®¢å æ¯” / å®¢å•ä»·", next:"åœºæ™¯æƒç›Šï¼šæ´—è¡£/æ—©é¤åˆ¸è”åŠ¨æˆ¿ä»·åŒ…"},
      {seg:"é‡‘ä¼šå‘˜ï¼ˆé«˜ä»·å€¼ï¼‰", desc:"å•†åŠ¡/å·®æ—…ï¼Œä¸­é«˜é¢‘", value:"æ›´å¼ºå‡çº§ã€å»¶è¿Ÿé€€æˆ¿ã€ä¸“å±å®¢æœï¼ˆè§†æ”¿ç­–ï¼‰", kpi:"å¤è´­ç‡ / æˆ¿æ™š", next:"ä¼ä¸šåè®®ä»· + ä¼šå‘˜ç­‰çº§åŠ é€Ÿ"},
      {seg:"é“‚é‡‘åŠä»¥ä¸Šï¼ˆæ——èˆ°ï¼‰", desc:"é«˜ç«¯å“ç‰Œä¸»åŠ›ï¼Œè¿½æ±‚ä½“éªŒç¡®å®šæ€§", value:"é«˜ç«¯å“ç‰Œä¼˜å…ˆå‡çº§ã€æƒç›Šå åŠ ã€ä½“éªŒä¿éšœ", kpi:"NPS / æŠ•è¯‰ç‡", next:"ä¸é«˜ç«¯ IoTï¼ˆç¡çœ /ARï¼‰ç»‘å®šä¸ºâ€œå¯å”®å–æƒç›Šâ€"},
      {seg:"è¿è¥æ´»åŠ¨ï¼ˆå¢é•¿ï¼‰", desc:"ç§¯åˆ†/åˆ¸/è”å/èŠ‚æ—¥æ´»åŠ¨", value:"å…¨ç§¯åˆ†å…‘æ¢/é™æ—¶æŠ˜æ‰£/åŠ è´­ç¤¼åŒ…ï¼ˆç¤ºä¾‹ï¼‰", kpi:"æ´»åŠ¨ GMV / å¬å›ç‡", next:"A/B å®éªŒ + åŸå¸‚/äººç¾¤åˆ†å±‚æŠ•æ”¾"},
    ];

        toast("å·²æ›´æ–°å®¡æ‰¹çŠ¶æ€ï¼ˆæ¼”ç¤ºï¼‰");
        render();
      };

      $("approveSleep")?.addEventListener("click", ()=> toggle("sleep"));
      $("approveAR")?.addEventListener("click", ()=> toggle("ar"));
      $("goSleep")?.addEventListener("click", ()=>{
        const on = state.premiumByHotel[r.hotelCode]?.sleep;
        if(!on){ toast("ç¡çœ æ¨¡å—æœªå¼€é€š"); return; }
        toast("ç¡çœ æ¨¡å—ï¼šå·²å¼€é€šï¼ˆæ¼”ç¤ºï¼‰");
      });
      $("goAR")?.addEventListener("click", ()=>{
        const on = state.premiumByHotel[r.hotelCode]?.ar;
        if(!on){ toast("AR æ¨¡å—æœªå¼€é€š"); return; }
        toast("AR æ¨¡å—ï¼šå·²å¼€é€šï¼ˆæ¼”ç¤ºï¼‰");
      });
      return;
    }

    if(state.view==="fleet"){
      // category filter not meaningful here
      const q = state.q.trim().toLowerCase();
      let rows = state.fleet;
      if(state.filterHotel !== "ALL") rows = rows.filter(r=>r.hotelCode===state.filterHotel);
      if(q) rows = rows.filter(r=>Object.values(r).join(" ").toLowerCase().includes(q));
      return rows;
    }
    if(state.view==="devices") return applyFilters(state.devices);
    if(state.view==="alerts") return applyFilters(state.alerts);
    if(state.view==="workorders") return applyFilters(state.workorders);
    if(state.view==="premium") return applyFilters(state.premiumRows||[]);
    if(state.view==="member") return applyFilters(state.memberRows||[]);
    return [];
  }

  function setActiveNav(){
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.view===state.view);
    });
  }

  function renderHeader(){
    const meta = VIEW_META[state.view];
    $("viewTitle").textContent = meta.title;
    $("viewSubtitle").textContent = meta.subtitle;

    const isScenes = state.view==="scenes";
    const isROI = state.view==="roi";
    $("sceneForm").style.display = isScenes ? "block" : "none";
    $("roiForm").style.display = isROI ? "block" : "none";
    $("contextForm").style.display = (isScenes || isROI) ? "none" : "block";

    $("btnQuickAction").textContent = (isScenes ? "æ‰§è¡Œåœºæ™¯" : isROI ? "å¤åˆ¶è¯æœ¯" : state.view==="premium" ? "æ€»éƒ¨å®¡æ‰¹" : "ä¸€é”®å¤„ç½®");
  }

  function renderKPIs(rows){
    const wrap = $("kpiCards");
    if(state.view==="scenes" || state.view==="roi"){
      wrap.style.display = "none";
      return;
    }
    wrap.style.display = "grid";
    const kpis = VIEW_META[state.view].kpis(rows);
    wrap.innerHTML = "";
    kpis.forEach(k=>{
      const dot = k.dot ? `<span class="dot" style="${k.dot==='good'?'background:var(--good)':''}${k.dot==='warn'?'background:var(--warn)':''}${k.dot==='bad'?'background:var(--bad)':''}"></span>` : `<span class="dot"></span>`;
      wrap.insertAdjacentHTML("beforeend", `
        <div class="kpi">
          <div class="label">${dot}${escapeHTML(k.label)}</div>
          <div class="value">${escapeHTML(String(k.value))}</div>
          <div class="hint">${escapeHTML(k.hint||"")}</div>
        </div>
      `);
    });
  }

  function rowKey(r){ return r.id || r.hotelCode || JSON.stringify(r); }

  function renderTable(rows){
    const thead = $("thead");
    const tbody = $("tbody");
    if(state.view==="scenes" || state.view==="roi"){
      $("tableWrap").style.display = "none";
      thead.innerHTML = "";
      tbody.innerHTML = "";
      return;
    }
    $("tableWrap").style.display = "block";

    const cols = VIEW_META[state.view].columns;
    thead.innerHTML = `<tr>${cols.map(c=>`<th>${escapeHTML(c.label)}</th>`).join("")}</tr>`;
    tbody.innerHTML = rows.map(r=>{
      const tds = cols.map(c=>{
        const val = c.render ? c.render(r) : escapeHTML(r[c.key] ?? "");
        return `<td>${val}</td>`;
      }).join("");
      const sel = state.selected && state.selected.__key === rowKey(r) ? 'style="background: rgba(170,220,255,.08)"' : '';
      return `<tr data-key="${rowKey(r)}" ${sel}>${tds}</tr>`;
    }).join("");

    tbody.querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const key = tr.dataset.key;
        const found = rows.find(x=>rowKey(x)===key);
        if(found){
          state.selected = Object.assign({__key:key}, found);
          renderDetail();
          tbody.querySelectorAll("tr").forEach(rtr=>{
            rtr.style.background = (rtr.dataset.key===key) ? "rgba(170,220,255,.08)" : "";
          });
        }
      });
    });
  }

  function renderDetail(){
    const d = $("detail");
    if(state.view==="scenes"){
      $("detailMeta").textContent = "åœºæ™¯é¢„è§ˆ";
      d.innerHTML = renderSceneDetailHTML();
      bindSceneDetailActions();
      return;
    }
    if(state.view==="roi"){
      $("detailMeta").textContent = "ROI è¾“å‡º";
      d.innerHTML = renderROIDetailHTML();
      bindROIDetailActions();


    if(state.view==="member"){
      $("detailMeta").textContent = "ä¼šå‘˜è¿è¥è§†è§’";
      d.innerHTML = `
        <h4>åä½ä¼šä¼šå‘˜ Â· è¿è¥é—­ç¯ï¼ˆæ¼”ç¤ºï¼‰</h4>
        <p>å·¦ä¾§ä¸ºâ€œä¼šå‘˜åˆ†å±‚/æ´»åŠ¨ç­–ç•¥â€æ¸…å•ï¼›å³ä¾§ç”¨äºå‘ˆç°ä¸é—¨åº—è¿è¥çš„è”åŠ¨ï¼šä»·æ ¼ã€æƒç›Šã€å±¥çº¦ä¸ä½“éªŒæŒ‡æ ‡ã€‚</p>
        <div class="row" style="margin-top:10px;">
          <span class="tag good"><span class="s"></span>ç›´è®¢å…¥å£</span>
          <span class="tag"><span class="s"></span>ç§¯åˆ†èµ„äº§</span>
          <span class="tag warn"><span class="s"></span>æƒç›Šå±¥çº¦</span>
        </div>
        <p class="note" style="margin-top:10px;">å…³é”®ç†å¿µï¼šæŠŠâ€œä¼šå‘˜æƒç›Šâ€åšæˆå¯äº¤ä»˜çš„æœåŠ¡èƒ½åŠ›ï¼ˆIoTã€SOPã€SLAï¼‰ï¼Œè€Œä¸æ˜¯ä»…é æŠ˜æ‰£ä¸åˆ¸ã€‚</p>
      `;
      return;
    }

    if(state.view==="premium"){
      $("detailMeta").textContent = "æ€»éƒ¨å®¡æ‰¹é¢æ¿";
      d.innerHTML = `
        <h4>æ€»éƒ¨å®¡æ‰¹ Â· é«˜ç«¯èƒ½åŠ›å¼€é€š</h4>
        <p>é€‰æ‹©å·¦ä¾§â€œé«˜ç«¯èƒ½åŠ›â€åˆ—è¡¨ä¸­çš„é—¨åº—è¡Œï¼Œå¯åœ¨æ­¤å¯¹è¯¥é—¨åº—è¿›è¡Œå®¡æ‰¹å¼€é€šï¼ˆæ¼”ç¤ºï¼‰ã€‚</p>
        <p class="note">è§„åˆ™ï¼šä»… <span class="mono">èŠ±é—´å ‚ / å–œæ‚¦</span> ç­‰é«˜ç«¯ä¸è¯•ç‚¹é—¨åº—å¯ç”³è¯·ï¼›å…¨å­£/æ¡”å­ç­‰æ ‡å‡†ç‰ˆé»˜è®¤ä¸å¼€æ”¾ï¼Œä»¥ç¨³å®šä¸é™æœ¬ä¸ºä¼˜å…ˆã€‚</p>
      `;
      return;
    }

      return;
    }


    if(!state.selected){
      $("detailMeta").textContent = "æœªé€‰æ‹©";
      if(state.view==="devices"){
        const count = lowBatteryLocks(10).length;
        d.innerHTML = `
          <h4>è®¾å¤‡è¿è¥å¿«æ·åŠ¨ä½œ</h4>
          <p>ä½ å¯ä»¥åœ¨è¿™é‡Œä¸€é”®ç”Ÿæˆâ€œé—¨é”ç”µé‡â‰¤10%â€çš„æˆ¿é—´æ¸…å•ï¼Œå¹¶æ‰¹é‡æ´¾å‘æ›´æ¢ç”µæ± å·¥å•ï¼ˆæ¼”ç¤ºï¼‰ã€‚</p>
          <p><span class="muted">å½“å‰è¿‡æ»¤èŒƒå›´å†…ä½ç”µé‡é—¨é”ï¼š</span><span class="mono">${count}</span></p>
          <div class="row">
            <span class="chip" id="actLowBattery">ä¸€é”®ç”Ÿæˆæ¸…å•å¹¶æ´¾å•</span>
            <span class="chip" id="actExportDevices">å¯¼å‡ºå½“å‰è®¾å¤‡åˆ—è¡¨</span>
            <span class="chip" id="actGoROI">æŸ¥çœ‹åŠ ç›Ÿ ROI</span>
          </div>
          <p class="note">çœŸå®ç³»ç»Ÿå¯å¯¹æ¥é—¨é”å‚å•†/ç½‘å…³ä¸ŠæŠ¥çš„ç”µé‡é¥æµ‹ï¼Œæˆ–é€šè¿‡å‘¨æœŸæ€§å·¡æ£€è‡ªåŠ¨é‡‡é›†ï¼Œå¹¶åœ¨é˜ˆå€¼è§¦å‘æ—¶ç”Ÿæˆå·¥å•ä¸SLAã€‚</p>
        `;
        $("actLowBattery")?.addEventListener("click", ()=> $("btnQuickAction")?.click());
        $("actExportDevices")?.addEventListener("click", ()=> exportCurrentView());
        $("actGoROI")?.addEventListener("click", ()=>{ state.view="roi"; render(); toast("å·²åˆ‡æ¢åˆ°åŠ ç›Ÿ ROI"); });
        return;
      }
      d.innerHTML = `
        <h4>è¯·é€‰æ‹©ä¸€æ¡è®°å½•</h4>
        <p>å·¦ä¾§ç‚¹å‡»é…’åº— / è®¾å¤‡ / å‘Šè­¦ / å·¥å•ï¼Œå°†åœ¨è¿™é‡Œæ˜¾ç¤ºå»ºè®®ã€SOP ä¸å¿«æ·åŠ¨ä½œã€‚</p>
        <div class="row">
          <span class="chip">ä¸€é”®æ´¾å•</span>
          <span class="chip">è§¦å‘åœºæ™¯</span>
          <span class="chip">æŸ¥çœ‹å†å²</span>
        </div>
      `;
      return;
    }
    $("detailMeta").textContent = `æ›´æ–°äº ${nowTs()}`;

    if(state.view==="fleet"){
      const r = state.selected;
      d.innerHTML = `
        <h4>${escapeHTML(r.hotel)}</h4>
        <p><span class="muted">é—¨åº—ï¼š</span><span class="mono">${escapeHTML(r.hotelCode)}</span>ã€€ã€€<span class="muted">åŸå¸‚/å“ç‰Œï¼š</span>${escapeHTML(r.city)} Â· ${escapeHTML(r.brand)}</p>
        <p><span class="muted">è¦†ç›–ç‡ï¼š</span><span class="mono">${r.coverage}%</span>ã€€ã€€<span class="muted">åœ¨çº¿ï¼š</span><span class="mono">${r.online}</span>ã€€ã€€<span class="muted">ç¦»çº¿ï¼š</span><span class="mono">${r.offline}</span>ã€€ã€€<span class="muted">é™çº§ï¼š</span><span class="mono">${r.degraded}</span></p>
        <p><span class="muted">æœªé—­ç¯å‘Šè­¦ï¼š</span><span class="mono">${r.alertsOpen}</span>ã€€ã€€<span class="muted">èƒ½è€—é£é™©ï¼š</span><span class="mono">${r.energyRisk}</span></p>
        <p><span class="muted">å»ºè®®ï¼š</span>ä¼˜å…ˆæ²»ç†â€œç½‘å…³ç¦»çº¿/ç½‘ç»œè´¨é‡â€ï¼Œå…¶æ¬¡å¯¹é—¨é”ä½ç”µé‡åšâ€œæ‰¹é‡é¢„é˜²æ€§æ›´æ¢â€ï¼Œæœ€åç”¨â€œé€€æˆ¿èŠ‚èƒ½â€ç­–ç•¥ç¨³å®šèƒ½è€—ä¸æŠ•è¯‰ã€‚</p>
        <div class="row">
          <span class="chip" id="actGoDevices">è¿›å…¥è®¾å¤‡ä¸­å¿ƒï¼ˆè¯¥é…’åº—ï¼‰</span>
          <span class="chip" id="actGoAlerts">æŸ¥çœ‹å‘Šè­¦ï¼ˆè¯¥é…’åº—ï¼‰</span>
          <span class="chip" id="actScore">ç”Ÿæˆé—¨åº—æ²»ç†è¯„åˆ†</span>
        </div>
      `;
      $("actGoDevices")?.addEventListener("click", ()=>{
        state.filterHotel = r.hotelCode;
        $("filterHotel").value = state.filterHotel;
        state.view = "devices";
        state.selected = null;
        render();
        toast("å·²åˆ‡æ¢åˆ°è®¾å¤‡ä¸­å¿ƒï¼Œå¹¶é”å®šé—¨åº—è¿‡æ»¤");
      });
      $("actGoAlerts")?.addEventListener("click", ()=>{
        state.filterHotel = r.hotelCode;
        $("filterHotel").value = state.filterHotel;
        state.view = "alerts";
        state.selected = null;
        render();
        toast("å·²åˆ‡æ¢åˆ°å‘Šè­¦ä¸­å¿ƒï¼Œå¹¶é”å®šé—¨åº—è¿‡æ»¤");
      });
      $("actScore")?.addEventListener("click", ()=>{
        toast("æ²»ç†è¯„åˆ†å·²ç”Ÿæˆï¼ˆæ¼”ç¤ºï¼‰ï¼šè¦†ç›–ç‡/ç¦»çº¿ç‡/é—­ç¯ç‡/ç‰ˆæœ¬ä¸€è‡´æ€§");
      });
      return;
    }

    if(state.view==="devices"){
      const r = state.selected;
      d.innerHTML = `
        <h4>${escapeHTML(r.id)} Â· ${escapeHTML(r.hotel)}</h4>
        <p><span class="muted">æˆ¿é—´/åŒºåŸŸï¼š</span><span class="mono">${escapeHTML(r.room)}</span>ã€€ã€€<span class="muted">å“ç±»ï¼š</span>${tagCat(r.category)}ã€€ã€€<span class="muted">çŠ¶æ€ï¼š</span>${tagStatus(r.status)}</p>
        <p><span class="muted">ä¾›åº”å•†ï¼š</span>${escapeHTML(r.vendor)}ã€€ã€€<span class="muted">åè®®ï¼š</span><span class="mono">${escapeHTML(r.protocol)}</span>ã€€ã€€<span class="muted">å›ºä»¶ï¼š</span><span class="mono">${escapeHTML(r.firmware)}</span></p>
        <p><span class="muted">å¥åº·åº¦ï¼š</span><span class="mono">${r.health}</span>${r.battery===null ? "" : `ã€€ã€€<span class="muted">ç”µé‡ï¼š</span><span class="mono">${r.battery}%</span>`}ã€€ã€€<span class="muted">æœ€è¿‘å¿ƒè·³ï¼š</span>${escapeHTML(r.lastSeen)}</p>
        <p><span class="muted">å»ºè®®ï¼š</span>${escapeHTML(r.notes)}</p>
        <div class="row">
          <span class="chip" id="actWO">ä»è®¾å¤‡ç”Ÿæˆå·¥å•</span>
          <span class="chip" id="actUpgrade">å®‰æ’å›ºä»¶å‡çº§</span>
          <span class="chip" id="actRunScene">å¯¹è¯¥æˆ¿æ‰§è¡Œåœºæ™¯</span>
        </div>
      `;
      bindCommonActions();
      return;
    }

    if(state.view==="alerts"){
      const r = state.selected;
      d.innerHTML = `
        <h4>${escapeHTML(r.id)} Â· ${escapeHTML(r.type)}</h4>
        <p><span class="muted">ç­‰çº§ï¼š</span>${tagSev(r.sev)}ã€€ã€€<span class="muted">çŠ¶æ€ï¼š</span>${alertStatusTag(r.status)}ã€€ã€€<span class="muted">å‘ç”Ÿï¼š</span>${escapeHTML(r.created)}</p>
        <p><span class="muted">é…’åº—ï¼š</span>${escapeHTML(r.hotel)}ã€€ã€€<span class="muted">æˆ¿é—´/åŒºåŸŸï¼š</span><span class="mono">${escapeHTML(r.room)}</span></p>
        <p><span class="muted">å“ç±»ï¼š</span>${tagCat(r.category)}ã€€ã€€<span class="muted">è®¾å¤‡ï¼š</span><span class="mono">${escapeHTML(r.deviceId)}</span></p>
        <p><span class="muted">å¤„ç½®å»ºè®®ï¼š</span>${escapeHTML(r.msg)}</p>
        <div class="row">
          <span class="chip" id="actAck">ç¡®è®¤ï¼ˆACKï¼‰</span>
          <span class="chip" id="actWO">ç”Ÿæˆå·¥å•</span>
          <span class="chip" id="actClose">å…³é—­å‘Šè­¦</span>
        </div>
      `;
      bindCommonActions();
      return;
    }

    if(state.view==="workorders"){
      const r = state.selected;
      d.innerHTML = `
        <h4>${escapeHTML(r.id)} Â· ${escapeHTML(r.title)}</h4>
        <p><span class="muted">ä¼˜å…ˆçº§ï¼š</span>${tagSev(r.priority)}ã€€ã€€<span class="muted">çŠ¶æ€ï¼š</span>${tagWO(r.state)}ã€€ã€€<span class="muted">SLAï¼š</span><span class="mono">${escapeHTML(r.sla)}</span></p>
        <p><span class="muted">é…’åº—ï¼š</span>${escapeHTML(r.hotel)}ã€€ã€€<span class="muted">æˆ¿é—´/åŒºåŸŸï¼š</span><span class="mono">${escapeHTML(r.room)}</span></p>
        <p><span class="muted">å“ç±»ï¼š</span>${tagCat(r.category)}ã€€ã€€<span class="muted">è®¾å¤‡ï¼š</span><span class="mono">${escapeHTML(r.deviceId)}</span></p>
        <p><span class="muted">è´Ÿè´£äººï¼š</span>${escapeHTML(r.owner)}ã€€ã€€<span class="muted">æœ€è¿‘æ›´æ–°ï¼š</span>${escapeHTML(r.updated)}</p>
        <p><span class="muted">è¯´æ˜ï¼š</span>${escapeHTML(r.desc)}</p>
        <div class="row">
          <span class="chip" id="actStart">å¼€å§‹å¤„ç†</span>
          <span class="chip" id="actDone">æ ‡è®°å®Œæˆ</span>
          <span class="chip" id="actSLA">å‡çº§SLA</span>
        </div>
      `;
      bindCommonActions();
      return;
    }
  }

  function bindCommonActions(){
    $("actWO")?.addEventListener("click", ()=> createWorkOrderFromSelection());
    $("actUpgrade")?.addEventListener("click", ()=> toast("å·²åˆ›å»ºå›ºä»¶å‡çº§çª—å£ï¼ˆæ¼”ç¤ºï¼‰"));
    $("actRunScene")?.addEventListener("click", ()=>{
      // prefill scenes
      state.view = "scenes";
      render();
      toast("å·²åˆ‡æ¢åˆ°åœºæ™¯è”åŠ¨ï¼Œå¯é€‰æ‹©æ¨¡æ¿å¹¶æ‰§è¡Œï¼ˆæ¼”ç¤ºï¼‰");
    });

    $("actAck")?.addEventListener("click", ()=>{
      if(state.view!=="alerts" || !state.selected) return;
      const target = state.alerts.find(a=>a.id===state.selected.id);
      if(target && target.status==="OPEN"){
        target.status="ACK";
        toast("å‘Šè­¦å·²ç¡®è®¤ï¼ˆACKï¼‰");
        updateBadges();
        state.selected = Object.assign({__key:target.id}, target);
        render();
      }else{
        toast("è¯¥å‘Šè­¦æ— éœ€é‡å¤ç¡®è®¤");
      }
    });

    $("actClose")?.addEventListener("click", ()=>{
      if(state.view!=="alerts" || !state.selected) return;
      const target = state.alerts.find(a=>a.id===state.selected.id);
      if(target && target.status!=="CLOSED"){
        target.status="CLOSED";
        toast("å‘Šè­¦å·²å…³é—­ï¼ˆCLOSEDï¼‰");
        updateBadges();
        state.selected = null;
        render();
      }
    });

    $("actStart")?.addEventListener("click", ()=>{
      if(state.view!=="workorders" || !state.selected) return;
      const target = state.workorders.find(w=>w.id===state.selected.id);
      if(target && target.state!=="DONE"){
        target.state="IN_PROGRESS";
        target.updated="åˆšåˆš";
        toast("å·¥å•å·²è¿›å…¥å¤„ç†ä¸­");
        updateBadges();
        state.selected = Object.assign({__key:target.id}, target);
        render();
      }
    });

    $("actDone")?.addEventListener("click", ()=>{
      if(state.view!=="workorders" || !state.selected) return;
      const target = state.workorders.find(w=>w.id===state.selected.id);
      if(target){
        target.state="DONE";
        target.updated="åˆšåˆš";
        toast("å·¥å•å·²æ ‡è®°å®Œæˆ");
        updateBadges();
        state.selected = null;
        render();
      }
    });

    $("actSLA")?.addEventListener("click", ()=> toast("å·²è§¦å‘ SLA å‡çº§ï¼ˆæ¼”ç¤ºï¼‰"));
  }

  
  function lowBatteryLocks(thresholdPct=10){
    // returns locks with battery <= threshold, respecting current hotel filter if any
    const hotelFilter = state.filterHotel;
    return state.devices
      .filter(d => d.category==="LOCK" && typeof d.battery==="number" && d.battery<=thresholdPct)
      .filter(d => hotelFilter==="ALL" ? true : d.hotelCode===hotelFilter)
      .sort((a,b)=> (a.hotelCode+a.room).localeCompare(b.hotelCode+b.room));
  }

  function buildLowBatteryCSV(list){
    const head = ["hotelCode","hotel","room","deviceId","batteryPct","lastSeen","vendor","firmware"];
    const lines = [head.join(",")].concat(list.map(d=>{
      const row = [d.hotelCode,d.hotel,d.room,d.id,d.battery,d.lastSeen,d.vendor,d.firmware]
        .map(x => `"${String(x??"").replaceAll('"','""')}"`);
      return row.join(",");
    }));
    return lines.join("\n");
  }

  function createBatteryWorkOrders(list){
    const created = [];
    list.forEach(d=>{
      const newId = "WO-" + Math.floor(8000 + Math.random()*999);
      const wo = {
        id: newId,
        hotelCode: d.hotelCode,
        hotel: d.hotel,
        room: d.room,
        deviceId: d.id,
        category: d.category,
        priority: "P2",
        state: "NEW",
        owner: "å·¥ç¨‹éƒ¨",
        sla: "24h",
        updated: "åˆšåˆš",
        title: `æ›´æ¢ç”µæ±  Â· æ™ºèƒ½é—¨é”ï¼ˆ<=10%ï¼‰`,
        desc: `ç³»ç»Ÿæ£€æµ‹åˆ°é—¨é”ç”µé‡ ${d.battery}%ï¼ˆé˜ˆå€¼ 10%ï¼‰ã€‚å»ºè®®ï¼šæ‰¹é‡é¢„é˜²æ€§æ›´æ¢ç”µæ± ï¼›æ›´æ¢åå›å†™ç”µé‡ä¸å…³é—­ç›¸å…³å‘Šè­¦ã€‚`
      };
      state.workorders.unshift(wo);
      created.push(wo);
    });
    updateBadges();
    return created;
  }

  function createWorkOrderFromSelection(){
    if(!state.selected){
      toast("è¯·å…ˆé€‰æ‹©ä¸€æ¡è®°å½•");
      return;
    }
    let wo = null;
    const newId = "WO-" + Math.floor(8000 + Math.random()*999);
    if(state.view==="devices"){
      const r = state.selected;
      wo = {
        id: newId,
        hotelCode: r.hotelCode,
        hotel: r.hotel,
        room: r.room,
        deviceId: r.id,
        category: r.category,
        priority: "P2",
        state: "NEW",
        owner: "å·¥ç¨‹éƒ¨",
        sla: "8h",
        updated: "åˆšåˆš",
        title: `ç°åœºå·¡æ£€ Â· ${catName(r.category)} Â· å¥åº·å¤æ ¸`,
        desc: `ä»è®¾å¤‡ ${r.id} ç”Ÿæˆã€‚å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œ/åè®®/ä¾›ç”µï¼›å¿…è¦æ—¶å‡çº§å›ºä»¶å¹¶å›å†™ç»“æœã€‚`
      };
    }else if(state.view==="alerts"){
      const r = state.selected;
      wo = {
        id: newId,
        hotelCode: r.hotelCode,
        hotel: r.hotel,
        room: r.room,
        deviceId: r.deviceId,
        category: r.category,
        priority: r.sev,
        state: "NEW",
        owner: "å€¼ç­ç»ç†",
        sla: r.sev==="P1" ? "2h" : "8h",
        updated: "åˆšåˆš",
        title: `å‘Šè­¦å¤„ç½® Â· ${r.type}`,
        desc: `å…³è”å‘Šè­¦ ${r.id}ï¼ˆ${r.sev}ï¼‰ã€‚å»ºè®®ï¼š${r.msg}`
      };
    }else{
      toast("å½“å‰è§†å›¾ä¸æ”¯æŒç”Ÿæˆå·¥å•");
      return;
    }

    state.workorders.unshift(wo);
    updateBadges();
    toast(`å·²ç”Ÿæˆå·¥å• ${newId}`);

    // optional: jump
    state.view = "workorders";
    state.selected = null;
    render();
  }

  function catName(k){
    const m = {LOCK:"æ™ºèƒ½é—¨é”",HVAC:"ç©ºè°ƒ",LIGHT:"ç¯å…‰",LAUNDRY:"æ´—è¡£æœº",GATEWAY:"ç½‘å…³"};
    return m[k]||k;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCurrentView(){
    if(state.view==="scenes"){
      const conf = sceneConfig();
      downloadText("scene_config.json", JSON.stringify(conf, null, 2));
      toast("å·²å¯¼å‡ºåœºæ™¯é…ç½®ï¼ˆjsonï¼‰");
      return;
    }
    if(state.view==="roi"){
      const d = roiCompute();
      const lines = [
        `åŠ ç›Ÿ ROI å¯¼å‡ºï¼ˆ${nowTs()}ï¼‰`,
        `æˆ¿é—´æ•°ï¼š${d.rooms}`,
        `å¥—é¤ï¼š${d.packName}`,
        `ä¸€æ¬¡æ€§æŠ•å…¥ CAPEXï¼š${fmtMoney(d.capexTotal)} å…ƒ`,
        `æ¯æœˆå‡€æ”¶ç›Šï¼š${fmtMoney(d.monthlyNet)} å…ƒ/æœˆ`,
        `å›æœ¬å‘¨æœŸï¼š${d.paybackMonths} æœˆ`,
        `ä¸‰å¹´å‡€æ”¶ç›Šï¼š${fmtMoney(d.net3y)} å…ƒ`
      ].join("\n");
      downloadText("roi_export.txt", lines);
      toast("å·²å¯¼å‡º ROIï¼ˆtxtï¼‰");
      return;
    }
    const rows = currentRows();
    const cols = VIEW_META[state.view].columns;
    const head = cols.map(c=>c.label);
    const csv = [head.join(",")].concat(rows.map(r=>{
      return cols.map(c=>{
        const raw = r[c.key];
        const v = (raw===undefined || raw===null) ? "" : String(raw).replaceAll('"','""');
        return `"${v}"`;
      }).join(",");
    })).join("\n");
    downloadText(`${state.view}_export.csv`, csv);
    toast("å·²å¯¼å‡ºå½“å‰è§†å›¾ï¼ˆcsvï¼‰");
  }

  /* Scenes */
  function syncSceneLabels(){
    $("sceneTempVal").textContent = $("sceneTemp").value;
    $("sceneLightVal").textContent = $("sceneLight").value;
  }

  function sceneConfig(){
    const roomVal = $("sceneRoom").value || "";
    const parts = roomVal.split("ï½œ");
    const hotelCode = parts[0] || "";
    const room = parts[1] || "";
    return {
      template: $("sceneTemplate").value,
      target: { hotelCode, room },
      params: {
        hvacTempC: Number($("sceneTemp").value),
        lightBrightnessPct: Number($("sceneLight").value)
      },
      generatedAt: nowTs()
    };
  }

  function renderSceneDetailHTML(){
    const conf = sceneConfig();
    const templateName = $("sceneTemplate").options[$("sceneTemplate").selectedIndex]?.text || "";
    return `
      <h4>åœºæ™¯è”åŠ¨ Â· é¢„è§ˆ</h4>
      <p><span class="muted">æ¨¡æ¿ï¼š</span>${escapeHTML(templateName)}</p>
      <p><span class="muted">ç›®æ ‡ï¼š</span><span class="mono">${escapeHTML(($("sceneRoom").value||""))}</span></p>
      <p><span class="muted">å‚æ•°ï¼š</span><span class="mono">ç©ºè°ƒ ${conf.params.hvacTempC}Â°C</span>ã€€ã€€<span class="mono">ç¯å…‰ ${conf.params.lightBrightnessPct}%</span></p>
      <p><span class="muted">è¯´æ˜ï¼š</span>è¯¥è”åŠ¨åœ¨çœŸå®ç³»ç»Ÿä¸­é€šå¸¸ç”± PMS äº‹ä»¶è§¦å‘ï¼ˆå…¥ä½/é€€æˆ¿/ç»­ä½/å…æ‰“æ‰°ï¼‰ï¼Œæ­¤å¤„æä¾›â€œæ‰‹åŠ¨æ‰§è¡Œâ€ç”¨äºæ¼”ç¤ºä¸è°ƒè¯•ã€‚</p>
      <div class="row">
        <span class="chip" id="scenePreview2">é¢„è§ˆè”åŠ¨æ•ˆæœ</span>
        <span class="chip" id="sceneExecute2">æ‰§è¡Œåœºæ™¯</span>
        <span class="chip" id="sceneExport2">å¯¼å‡ºé…ç½®</span>
      </div>
      <p class="note">å•†ä¸šåŒ–çš„å…³é”®ä¸æ˜¯â€œä¼šè”åŠ¨â€ï¼Œè€Œæ˜¯æŠŠè”åŠ¨å˜æˆâ€œå¯é…ç½®ã€å¯å¤åˆ¶ã€å¯è®¡è´¹â€çš„èƒ½åŠ›åŒ…ã€‚</p>
    `;
  }

  function bindSceneDetailActions(){
    $("scenePreview2")?.addEventListener("click", ()=> toast("é¢„è§ˆï¼šé—¨é”å¼€é”â†’ç¯å…‰æ¸äº®â†’ç©ºè°ƒè®¾å®šâ†’PMSå›å†™ï¼ˆæ¼”ç¤ºï¼‰"));
    $("sceneExecute2")?.addEventListener("click", ()=>{
      toast("å·²æ‰§è¡Œåœºæ™¯ï¼šæŒ‡ä»¤ä¸‹å‘æˆåŠŸç‡ 99%ï¼ˆæ¼”ç¤ºï¼‰");
      // create a demo workorder if scene fails condition
      if(Math.random()<0.12){
        toast("æç¤ºï¼šæ£€æµ‹åˆ°éƒ¨åˆ†è®¾å¤‡å“åº”è¶…æ—¶ï¼Œå»ºè®®ç”Ÿæˆå·¥å•ï¼ˆæ¼”ç¤ºï¼‰");
      }
    });
    $("sceneExport2")?.addEventListener("click", ()=>{
      const conf = sceneConfig();
      downloadText("scene_config.json", JSON.stringify(conf, null, 2));
      toast("å·²å¯¼å‡ºåœºæ™¯é…ç½®ï¼ˆjsonï¼‰");
    });
  }

  /* ROI */
  function syncROILabels(){
    $("roiRoomsVal").textContent = $("roiRooms").value;
    $("roiCapexVal").textContent = $("roiCapex").value;
    $("roiSaaSVal").textContent = $("roiSaaS").value;
    $("roiLaborSaveVal").textContent = Number($("roiLaborSave").value).toFixed(1);
    $("roiLaborCostVal").textContent = $("roiLaborCost").value;
    $("roiEnergyVal").textContent = $("roiEnergy").value;
    $("roiOpexVal").textContent = $("roiOpex").value;
  }

  function roiCompute(){
    const rooms = Number($("roiRooms").value);
    const capexPerRoom = Number($("roiCapex").value);
    const saasPerRoom = Number($("roiSaaS").value);
    const laborSavePer100 = Number($("roiLaborSave").value);
    const laborCost = Number($("roiLaborCost").value);
    const energyPerRoom = Number($("roiEnergy").value);
    const opexPerRoom = Number($("roiOpex").value);
    const pack = $("roiPack").value;

    const packName = $("roiPack").options[$("roiPack").selectedIndex].text;

    // pack factor: value density vs cost; used as a simple multiplier for energy & labor
    const factor = pack==="basic" ? 0.75 : (pack==="std" ? 1.00 : 1.15);

    const capexTotal = rooms * capexPerRoom;
    const saasMonthly = rooms * saasPerRoom;
    const opexMonthly = rooms * opexPerRoom;
    const laborSaveMonthly = (rooms/100.0) * laborSavePer100 * laborCost * factor;
    const energySaveMonthly = rooms * energyPerRoom * factor;

    const monthlyNet = Math.max(0, laborSaveMonthly + energySaveMonthly - saasMonthly - opexMonthly);
    const paybackMonths = monthlyNet>0 ? Math.max(1, Math.round(capexTotal / monthlyNet)) : 999;
    const net3y = monthlyNet*36 - capexTotal;

    return {rooms, capexPerRoom, saasPerRoom, laborSavePer100, laborCost, energyPerRoom, opexPerRoom, pack, packName, factor, capexTotal, saasMonthly, opexMonthly, laborSaveMonthly, energySaveMonthly, monthlyNet, paybackMonths, net3y};
  }

  function renderROIDetailHTML(){
    const d = roiCompute();
    const payback = d.paybackMonths>=999 ? "ä¸å¯å›æœ¬ï¼ˆå‡€æ”¶ç›Šä¸º0ï¼‰" : `${d.paybackMonths} ä¸ªæœˆ`;
    return `
      <h4>åŠ ç›Ÿ ROI Â· å†³ç­–æ‘˜è¦</h4>
      <p><span class="muted">æˆ¿é—´æ•°ï¼š</span><span class="mono">${d.rooms}</span>ã€€ã€€<span class="muted">å¥—é¤ï¼š</span>${escapeHTML(d.packName)}</p>
      <p><span class="muted">ä¸€æ¬¡æ€§æŠ•å…¥ CAPEXï¼š</span><span class="mono">${fmtMoney(d.capexTotal)}</span> å…ƒ</p>
      <p><span class="muted">æ¯æœˆèŠ‚çœäººåŠ›ï¼š</span><span class="mono">${fmtMoney(d.laborSaveMonthly)}</span> å…ƒ/æœˆ</p>
      <p><span class="muted">æ¯æœˆèŠ‚èƒ½æ”¶ç›Šï¼š</span><span class="mono">${fmtMoney(d.energySaveMonthly)}</span> å…ƒ/æœˆ</p>
      <p><span class="muted">æ¯æœˆå¹³å°è´¹ï¼š</span><span class="mono">${fmtMoney(d.saasMonthly)}</span> å…ƒ/æœˆã€€ã€€<span class="muted">æ¯æœˆè¿ç»´æˆæœ¬ï¼š</span><span class="mono">${fmtMoney(d.opexMonthly)}</span> å…ƒ/æœˆ</p>
      <p><span class="muted">æ¯æœˆå‡€æ”¶ç›Šï¼š</span><span class="mono">${fmtMoney(d.monthlyNet)}</span> å…ƒ/æœˆ</p>
      <p><span class="muted">å›æœ¬å‘¨æœŸï¼š</span><span class="mono">${payback}</span></p>
      <p><span class="muted">ä¸‰å¹´å‡€æ”¶ç›Šï¼š</span><span class="mono">${fmtMoney(d.net3y)}</span> å…ƒ</p>
      <div class="row">
        <span class="chip" id="roiPitch">ç”Ÿæˆä¸€æ®µâ€œå¯¹åŠ ç›Ÿå•†è®²â€çš„è¯æœ¯</span>
        <span class="chip" id="roiAssump">æŸ¥çœ‹å£å¾„/å‡è®¾</span>
        <span class="chip" id="roiExport">å¯¼å‡ºROI</span>
      </div>
      <p class="note">ä¸€æ®µå¥½è¯æœ¯è¦åŒæ—¶å‘½ä¸­ä¸‰ä»¶äº‹ï¼šé’±ï¼ˆå›æœ¬ï¼‰ã€ç¨³ï¼ˆSLAé—­ç¯ï¼‰ã€ä½“éªŒï¼ˆä½å®¢å£ç¢‘ï¼‰ã€‚</p>
    `;
  }

  function bindROIDetailActions(){
    $("roiPitch")?.addEventListener("click", ()=>{
      const d = roiCompute();
      const payback = d.paybackMonths>=999 ? "å½“å‰å£å¾„ä¸‹å‡€æ”¶ç›Šä¸è¶³ä»¥è¦†ç›–æŠ•å…¥" : `é¢„è®¡ ${d.paybackMonths} ä¸ªæœˆå›æœ¬`;
      const s = `æŒ‰â€œäººåŠ›èŠ‚çœ + èŠ‚èƒ½æ”¶ç›Š - å¹³å°è´¹ - è¿ç»´æˆæœ¬â€çš„å£å¾„æµ‹ç®—ï¼šé—¨åº— ${d.rooms} é—´æˆ¿ï¼ŒCAPEX çº¦ ${fmtMoney(d.capexTotal)} å…ƒï¼›æ¯æœˆå‡€æ”¶ç›Šçº¦ ${fmtMoney(d.monthlyNet)} å…ƒï¼Œ${payback}ã€‚æ›´é‡è¦çš„æ˜¯æŠŠè®¾å¤‡èƒ½åŠ›å°è£…æˆå¯å¤åˆ¶çš„è¿è¥SOPï¼ˆå…¥ä½æ¬¢è¿/é€€æˆ¿èŠ‚èƒ½/å…æ‰“æ‰°/å¤œé—´å…³æ€€ï¼‰ï¼Œå¹¶é€šè¿‡å‘Šè­¦-å·¥å•-SLAå½¢æˆé•¿æœŸå¯æ§çš„é—¨åº—æ²»ç†ä½“ç³»ã€‚`;
      navigator.clipboard?.writeText(s).catch(()=>{});
      toast("è¯æœ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå¦‚æƒé™å…è®¸ï¼‰");
    });
    $("roiAssump")?.addEventListener("click", ()=>{
      toast("å£å¾„ï¼šæœˆå‡€æ”¶ç›Š=äººåŠ›èŠ‚çœ+èŠ‚èƒ½æ”¶ç›Š-å¹³å°è´¹-è¿ç»´ï¼›å›æœ¬=CAPEX/æœˆå‡€æ”¶ç›Š");
    });
    $("roiExport")?.addEventListener("click", ()=> exportCurrentView());
  }

  function bindGlobalEvents(){
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.view = btn.dataset.view;
        state.selected = null;
        render();
        toast(`å·²åˆ‡æ¢ï¼š${VIEW_META[state.view].title}`);
      });
    });

    $("globalSearch").addEventListener("input", (e)=>{
      state.q = e.target.value;
      state.selected = null;
      render();
    });

    $("filterHotel").addEventListener("change", (e)=>{
      state.filterHotel = e.target.value;
      state.selected = null;
      render();
    });
    $("filterCategory").addEventListener("change", (e)=>{
      state.filterCategory = e.target.value;
      state.selected = null;
      render();
    });

    $("btnRefresh").addEventListener("click", refreshAll);
    $("btnExport").addEventListener("click", exportCurrentView);

    $("btnQuickAction").addEventListener("click", ()=>{
      if(state.view==="scenes"){
        $("sceneExecute")?.click();
        toast("å·²è§¦å‘æ‰§è¡Œï¼ˆæ¼”ç¤ºï¼‰");
        return;
      }
      if(state.view==="roi"){
        $("roiPitch")?.click();
        return;
      }

      if(state.view==="devices"){
        const list = lowBatteryLocks(10);
        if(!list.length){
          toast("æœªå‘ç°ç”µé‡<=10%çš„é—¨é”ï¼ˆå½“å‰è¿‡æ»¤èŒƒå›´å†…ï¼‰");
          return;
        }
        // Export list for ops, then create work orders
        downloadText("low_battery_locks.csv", buildLowBatteryCSV(list));
        const created = createBatteryWorkOrders(list);
        toast(`å·²ç”Ÿæˆä½ç”µé‡é—¨é”å·¥å•ï¼š${created.length} å•ï¼Œå¹¶å¯¼å‡ºæ¸…å•ï¼ˆcsvï¼‰`);
        // Jump to workorders view for verification
        state.view = "workorders";
        state.selected = null;
        render();
        return;
      }

      // generic
      if(state.view==="alerts"){
        // auto-ack first OPEN P1/P2
        const a = state.alerts.find(x=>x.status==="OPEN");
        if(a){
          a.status="ACK";
          toast(`å·²ç¡®è®¤å‘Šè­¦ ${a.id}ï¼ˆæ¼”ç¤ºï¼‰`);
          updateBadges();
          state.selected = null;
          render();
        }else{
          toast("æš‚æ— å¯ä¸€é”®å¤„ç½®çš„å‘Šè­¦ï¼ˆæ¼”ç¤ºï¼‰");
        }
        return;
      }
      toast("å·²è§¦å‘ä¸€é”®å¤„ç½®ï¼šæ´¾å•/å‡çº§/é—­ç¯ï¼ˆæ¼”ç¤ºï¼‰");
    });

    $("toggleTheme").addEventListener("click", ()=>{
      state.theme = state.theme==="dark" ? "light" : "dark";
      applyTheme();
      toast("ä¸»é¢˜å·²åˆ‡æ¢");
    });

    // scenes bindings
    ["sceneTemplate","sceneRoom","sceneTemp","sceneLight"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        syncSceneLabels();
        if(state.view==="scenes") renderDetail();
      });
      $(id).addEventListener("change", ()=>{
        syncSceneLabels();
        if(state.view==="scenes") renderDetail();
      });
    });

    $("scenePreview")?.addEventListener("click", ()=> toast("é¢„è§ˆï¼šé—¨é”æˆæƒâ†’ç¯å…‰æ¸äº®â†’ç©ºè°ƒè®¾å®šâ†’PMSå›å†™ï¼ˆæ¼”ç¤ºï¼‰"));
    $("sceneExecute")?.addEventListener("click", ()=>{
      toast("æ‰§è¡ŒæˆåŠŸï¼šå…¥ä½æ¬¢è¿åœºæ™¯å·²ä¸‹å‘ï¼ˆæ¼”ç¤ºï¼‰");
      // simulate an alert creation sometimes
      if(Math.random()<0.10){
        const conf = sceneConfig();
        const a = {
          id: "ALT-" + Math.floor(9900 + Math.random()*999),
          hotelCode: conf.target.hotelCode,
          hotel: HOTELS.find(h=>h.code===conf.target.hotelCode)?.name || "æœªçŸ¥é—¨åº—",
          room: conf.target.room || "æœªçŸ¥æˆ¿é—´",
          deviceId: "DEV-XXXXX",
          category: "HVAC",
          type: "ç©ºè°ƒé€šè®¯å¼‚å¸¸",
          sev: "P2",
          status: "OPEN",
          created: "åˆšåˆš",
          msg: "åœºæ™¯æ‰§è¡Œæ—¶æ£€æµ‹åˆ°ç©ºè°ƒé€šè®¯è¶…æ—¶ï¼Œå»ºè®®è½¬å·¥å•æ’æŸ¥åè®®ç½‘å…³ä¸åœ°å€ç ã€‚"
        };
        state.alerts.unshift(a);
        updateBadges();
        toast("æç¤ºï¼šåœºæ™¯æ‰§è¡Œäº§ç”Ÿæ–°å‘Šè­¦ï¼ˆæ¼”ç¤ºï¼‰");
      }
    });
    $("sceneExport")?.addEventListener("click", ()=>{
      const conf = sceneConfig();
      downloadText("scene_config.json", JSON.stringify(conf, null, 2));
      toast("å·²å¯¼å‡ºåœºæ™¯é…ç½®ï¼ˆjsonï¼‰");
    });

    // roi bindings
    ["roiRooms","roiCapex","roiSaaS","roiLaborSave","roiLaborCost","roiEnergy","roiOpex","roiPack"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        syncROILabels();
        if(state.view==="roi") renderDetail();
      });
      $(id).addEventListener("change", ()=>{
        syncROILabels();
        if(state.view==="roi") renderDetail();
      });
    });
  }

  function applyTheme(){
    if(state.theme==="light"){
      document.body.classList.add("lightMode");
      $("themeBadge").textContent = "äº®";
    }else{
      document.body.classList.remove("lightMode");
      $("themeBadge").textContent = "æš—";
    }
  }

  function render(){
    setActiveNav();
    renderHeader();
    const rows = currentRows();
    renderKPIs(rows);
    renderTable(rows);
    renderDetail();
  }

  function refreshAll(){
    state.devices = genDevices();
    // Initialize premium approvals (simulated per hotel). Default: OFF.
    state.premiumByHotel = {};
    HOTELS.forEach(h=>{
      state.premiumByHotel[h.code] = { sleep:false, ar:false };
    });


    state.fleet = genHotelFleet(state.devices);
    // Build premium view rows
    state.premiumRows = state.fleet.map(f=>{
      const eligible = isPremiumEligibleBrand(f.brand);
      const p = state.premiumByHotel[f.hotelCode] || {sleep:false, ar:false};
      return {
        hotelCode: f.hotelCode,
        hotel: f.hotel,
        brand: f.brand,
        city: f.city,
        eligible,
        sleep: !!p.sleep,
        ar: !!p.ar,
        govern: eligible
          ? (p.sleep||p.ar ? "å»ºè®®å°†é«˜ç«¯èƒ½åŠ›ç»‘å®šæˆ¿å‹/æƒç›Šï¼Œå¹¶çº³å…¥å®¡è®¡æ—¥å¿—ã€‚" : "å»ºè®®å…ˆè¯•ç‚¹ 1-2 å®¶é—¨åº—ï¼Œå»ºç«‹å£å¾„ä¸SOPã€‚")
          : "æ ‡å‡†ç‰ˆé—¨åº—ä»¥ç¨³å®šä¸é™æœ¬ä¸ºä¼˜å…ˆã€‚"
      };
    });


    state.alerts = genAlerts(state.devices);
    state.workorders = genWorkOrders(state.alerts);

    // reset selection
    state.selected = null;

    // keep filter values but ensure dropdowns are set
    populateFilters();
    updateBadges();

    syncSceneLabels();
    syncROILabels();

    render();
    toast("æ•°æ®å·²åˆ·æ–°ï¼ˆæ¨¡æ‹Ÿï¼‰");
  }

  function boot(){
    bindGlobalEvents();
    refreshAll();
    applyTheme();
  }

  boot();

  // Override quick action to support: ä½ç”µé‡é—¨é”(<=10%) ä¸€é”®æ¸…å• + æ‰¹é‡æ´¾å•ï¼ˆæ¼”ç¤ºï¼‰
  const qa = $("btnQuickAction");
  if(qa){
    qa.addEventListener("click", (e)=>{
      if(state.view==="devices"){
        const rows = currentRows().filter(d=>d.category==="LOCK" && typeof d.battery==="number" && d.battery<=10);
        if(!rows.length){ toast("å½“å‰èŒƒå›´æ— é—¨é”ç”µé‡â‰¤10%çš„è®¾å¤‡"); return; }
        const list = rows.slice(0, 24).map(d=>`${d.hotelCode}ï½œ${d.room}ï½œ${d.battery}%ï½œ${d.id}`).join("\n");
        // Create workorders
        const created = rows.slice(0, 24).map((d,i)=>({
          id: "WO-AUTO-" + (90000+i),
          hotelCode: d.hotelCode,
          hotel: d.hotel,
          room: d.room,
          deviceId: d.id,
          category: d.category,
          priority: "P2",
          state: "NEW",
          owner: "å·¥ç¨‹éƒ¨",
          sla: "24h",
          updated: "åˆšåˆš",
          title: "æ›´æ¢ç”µæ±  Â· é—¨é”ç”µé‡ä½ï¼ˆâ‰¤10%ï¼‰",
          desc: `è‡ªåŠ¨å·¡æ£€è§¦å‘ï¼šé—¨é”ç”µé‡ ${d.battery}%ã€‚å»ºè®®é›†ä¸­æ´¾å•åˆ†æ‰¹æ›´æ¢ï¼Œé¿å…å¤œé—´æŠ•è¯‰ã€‚`
        }));
        state.workorders = created.concat(state.workorders);
        updateBadges();
        $("detailMeta").textContent = "è‡ªåŠ¨æ´¾å•ç»“æœ";
        $("detail").innerHTML = `
          <h4>å·²ç”Ÿæˆä½ç”µé‡æˆ¿é—´æ¸…å•ï¼ˆé—¨é”â‰¤10%ï¼‰</h4>
          <p class="muted">ç¤ºä¾‹æ¸…å•ï¼ˆæœ€å¤šå±•ç¤º 24 æ¡ï¼‰ï¼š</p>
          <pre style="white-space:pre-wrap;margin:10px 0;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:rgba(255,255,255,.88);font-size:12px;">${escapeHTML(list)}</pre>
          <div class="row">
            <span class="chip" id="jumpWO">è·³è½¬æŸ¥çœ‹æ–°å·¥å•</span>
            <span class="chip" id="copyList">å¤åˆ¶æ¸…å•</span>
          </div>
          <p class="note">çœŸå®ç³»ç»Ÿï¼šç”µé‡å¯ç”±é—¨é”é¥æµ‹/ç½‘å…³å·¡æ£€è‡ªåŠ¨æŠ“å–ï¼›é˜ˆå€¼è§¦å‘â†’ç”Ÿæˆå·¥å•â†’æŒ‰SLAé—­ç¯â†’å®¡è®¡ç•™ç—•ã€‚</p>
        `;
        $("jumpWO")?.addEventListener("click", ()=>{ state.view="workorders"; render(); toast("å·²åˆ‡æ¢åˆ°å·¥å•"); });
        $("copyList")?.addEventListener("click", async ()=>{
          try{ await navigator.clipboard.writeText(list); toast("å·²å¤åˆ¶æ¸…å•"); }catch(_){ toast("å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨æƒé™é™åˆ¶ï¼‰"); }
        });
      }
    }, {capture:true});
  }

})();
</script>
</body>
</html>
